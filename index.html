<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Lock-In 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --navy: #1B2A4A; --navy2: #243560;
  --gold: #B8962E; --gold-l: #F5EDD6;
  --cream: #FAF8F3; --white: #fff;
  --gray: #6B7280; --gray-l: #F3F4F6;
  --green: #2D6A2D; --green-l: #EAF4EA;
  --warn: #FFF3CD; --warn-fg: #7D5A00;
  --r: 16px; --rs: 10px;
  --sh: 0 4px 24px rgba(27,42,74,.10);
}
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
body { font-family:'DM Sans',sans-serif; background:var(--cream); color:var(--navy); min-height:100vh; }

/* HEADER */
.hdr { background:var(--navy); padding:14px 18px 12px; position:sticky; top:0; z-index:100; }
.hdr-row1 { display:flex; align-items:center; justify-content:space-between; margin-bottom:8px; }
.hdr-title { font-family:'Playfair Display',serif; color:var(--gold); font-size:20px; font-weight:700; }
.hdr-streak { background:var(--gold); color:var(--navy); border-radius:20px; padding:4px 12px; font-size:13px; font-weight:600; }
.hdr-row2 { display:flex; align-items:center; justify-content:space-between; gap:8px; }
.hdr-datetime { flex:1; }
.hdr-date-txt { color:rgba(255,255,255,.65); font-size:12px; font-weight:500; }
.hdr-clock-txt { color:var(--gold); font-family:'Playfair Display',serif; font-size:15px; margin-top:1px; }
.hdr-right { display:flex; align-items:center; gap:10px; }
.hdr-days-box { background:rgba(255,255,255,.1); border-radius:8px; padding:6px 10px; text-align:center; }
.hdr-days-num { color:var(--gold); font-family:'Playfair Display',serif; font-size:20px; font-weight:700; line-height:1; }
.hdr-days-lbl { color:rgba(255,255,255,.5); font-size:9px; margin-top:1px; }
.hdr-prog-box { text-align:right; }
.hdr-prog-pct { color:rgba(255,255,255,.8); font-size:12px; font-weight:600; margin-bottom:3px; }
.hdr-prog-bar { width:80px; height:5px; background:rgba(255,255,255,.15); border-radius:99px; overflow:hidden; }
.hdr-prog-fill { height:100%; background:var(--gold); border-radius:99px; transition:width .5s; width:0%; }

/* NAV */
.nav { background:var(--white); border-bottom:1px solid rgba(27,42,74,.08); display:flex; overflow-x:auto; scrollbar-width:none; position:sticky; top:88px; z-index:99; }
.nav::-webkit-scrollbar { display:none; }
.nb { padding:13px 16px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500; color:var(--gray); border:none; background:none; cursor:pointer; white-space:nowrap; border-bottom:2px solid transparent; transition:all .2s; }
.nb.active { color:var(--navy); border-bottom-color:var(--gold); font-weight:600; }

/* MAIN */
.main { padding:16px 16px 120px; max-width:600px; margin:0 auto; }

/* CARD */
.card { background:var(--white); border-radius:var(--r); padding:18px; margin-bottom:14px; box-shadow:var(--sh); }
.card-title { font-family:'Playfair Display',serif; font-size:17px; font-weight:700; color:var(--navy); margin-bottom:4px; }
.card-sub { font-size:12px; color:var(--gray); margin-bottom:14px; }
.slbl { font-size:11px; font-weight:600; color:var(--gray); text-transform:uppercase; letter-spacing:1px; margin:14px 0 8px; }

/* ENERGY */
.energy-row { display:flex; gap:6px; flex-wrap:wrap; }
.ebtn { width:38px; height:38px; border-radius:50%; border:2px solid var(--gray-l); background:var(--white); font-size:13px; font-weight:600; color:var(--gray); cursor:pointer; transition:all .2s; font-family:'DM Sans',sans-serif; }
.ebtn.active { background:var(--navy); border-color:var(--navy); color:var(--white); }

/* CHECKLIST */
.ci { display:flex; align-items:center; gap:12px; padding:11px 0; border-bottom:1px solid var(--gray-l); cursor:pointer; user-select:none; }
.ci:last-child { border-bottom:none; }
.cb { width:22px; height:22px; min-width:22px; border:2px solid var(--gray-l); border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:12px; transition:all .2s; }
.cb.done { background:var(--green); border-color:var(--green); color:#fff; }
.cl { font-size:14px; flex:1; }
.cl.done { color:var(--gray); text-decoration:line-through; }

/* BUTTONS */
.btn { padding:12px 18px; border-radius:var(--rs); font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; cursor:pointer; border:none; transition:all .2s; display:inline-flex; align-items:center; justify-content:center; gap:8px; width:100%; }
.btn-gold { background:var(--gold); color:var(--navy); }
.btn-navy { background:var(--navy); color:#fff; }
.btn-ghost { background:var(--gray-l); color:var(--navy); }
.btn-green { background:var(--green-l); color:var(--green); }
.btn-sm { padding:7px 13px; font-size:13px; border-radius:8px; width:auto; }
.btn-danger { background:#FEE2E2; color:#991B1B; }

/* TODAY TASKS */
.task-item { display:flex; align-items:center; gap:11px; padding:12px; background:var(--cream); border-radius:var(--rs); margin-bottom:8px; cursor:pointer; border:1.5px solid transparent; transition:all .2s; }
.task-item:hover { border-color:var(--gold-l); }
.task-item.done { opacity:.55; }
.task-check { width:24px; height:24px; min-width:24px; border:2px solid var(--gray-l); border-radius:6px; display:flex; align-items:center; justify-content:center; font-size:13px; transition:all .2s; }
.task-check.done { background:var(--green); border-color:var(--green); color:#fff; }
.task-info { flex:1; }
.task-title { font-size:14px; font-weight:500; }
.task-cat { font-size:12px; color:var(--gray); margin-top:2px; }
.badge { font-size:11px; font-weight:600; padding:3px 8px; border-radius:99px; }
.b-pend { background:var(--gray-l); color:var(--gray); }
.b-done { background:var(--green-l); color:var(--green); }
.b-part { background:var(--warn); color:var(--warn-fg); }

/* PROGRESS */
.pbw { background:var(--gray-l); border-radius:99px; height:7px; overflow:hidden; margin:8px 0 3px; }
.pbf { height:100%; background:linear-gradient(90deg,var(--gold),var(--navy)); border-radius:99px; transition:width .5s; }
.plbl { font-size:12px; color:var(--gray); display:flex; justify-content:space-between; }

/* WBS */
.cat-hdr { display:flex; align-items:center; justify-content:space-between; padding:11px 0 8px; cursor:pointer; }
.cat-name { font-family:'Playfair Display',serif; font-size:16px; font-weight:700; }
.cat-prog { font-size:12px; color:var(--gray); background:var(--gray-l); padding:3px 9px; border-radius:20px; }
.task-group { border-left:3px solid var(--gold-l); margin:0 0 10px 6px; padding-left:14px; }
.wbs-task { font-size:14px; font-weight:600; padding:8px 0 5px; display:flex; align-items:center; gap:7px; }
.wbs-task.done { color:var(--gray); }
.mt-row { display:flex; align-items:center; gap:9px; padding:7px 0; border-bottom:1px solid rgba(27,42,74,.05); cursor:pointer; }
.mt-row:last-child { border-bottom:none; }
.mt-check { width:17px; height:17px; min-width:17px; border:2px solid var(--gray-l); border-radius:4px; display:flex; align-items:center; justify-content:center; font-size:10px; transition:all .2s; }
.mt-check.done { background:var(--gold); border-color:var(--gold); color:#fff; }
.mt-lbl { font-size:13px; flex:1; }
.mt-lbl.done { color:var(--gray); text-decoration:line-through; }

/* SUPPLEMENT */
.s-day { background:var(--navy); color:#fff; border-radius:var(--rs); padding:10px 14px; margin-bottom:10px; font-size:14px; font-weight:600; }
.s-row { display:flex; gap:10px; padding:9px 0; border-bottom:1px solid var(--gray-l); }
.s-row:last-child { border-bottom:none; }
.s-time { font-size:12px; font-weight:600; color:var(--gold); min-width:70px; }
.s-items { font-size:13px; flex:1; }
.s-note { font-size:11px; color:var(--gray); margin-top:2px; }
.wbox { background:var(--warn); border-left:4px solid var(--gold); border-radius:var(--rs); padding:10px 13px; margin-bottom:13px; font-size:13px; color:var(--warn-fg); }

/* KPI */
.kpi-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
.kpi-card { background:var(--cream); border-radius:var(--rs); padding:13px; border:1px solid rgba(27,42,74,.08); }
.kpi-val { font-family:'Playfair Display',serif; font-size:24px; font-weight:700; }
.kpi-lbl { font-size:12px; color:var(--gray); margin-top:3px; }
.kpi-tgt { font-size:11px; color:var(--gold); font-weight:600; margin-top:2px; }

/* ZINCIR */
.z-hero { background:linear-gradient(135deg,var(--navy),var(--navy2)); border-radius:var(--r); padding:22px 18px; margin-bottom:14px; display:flex; align-items:center; gap:18px; }
.z-num { font-family:'Playfair Display',serif; font-size:60px; font-weight:700; color:var(--gold); line-height:1; }
.z-info { flex:1; }
.z-lbl { color:#fff; font-size:16px; font-weight:600; }
.z-sub { color:rgba(255,255,255,.5); font-size:12px; margin-top:4px; }
.z-rec { color:var(--gold-l); font-size:13px; margin-top:8px; font-weight:500; }
.h-card { background:var(--white); border-radius:var(--r); padding:16px; margin-bottom:12px; box-shadow:var(--sh); }
.h-top { display:flex; align-items:center; gap:11px; margin-bottom:12px; }
.h-icon { font-size:24px; width:36px; text-align:center; }
.h-info { flex:1; }
.h-name { font-size:15px; font-weight:600; }
.h-sub { font-size:12px; color:var(--gray); margin-top:2px; }
.h-streak { text-align:right; }
.h-s-num { font-family:'Playfair Display',serif; font-size:30px; font-weight:700; color:var(--gold); line-height:1; }
.h-s-lbl { font-size:10px; color:var(--gray); }
.tick-btn { width:38px; height:38px; min-width:38px; border-radius:50%; border:2px solid var(--gray-l); background:var(--white); font-size:18px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all .2s; margin-left:6px; }
.tick-btn.done { background:var(--green); border-color:var(--green); color:#fff; }
.edit-btn { width:32px; height:32px; min-width:32px; border-radius:50%; border:1.5px solid var(--gray-l); background:var(--white); font-size:13px; cursor:pointer; display:flex; align-items:center; justify-content:center; margin-left:4px; }
.cal-wrap { overflow-x:auto; padding-bottom:2px; }
.cal-row { display:flex; gap:4px; min-width:max-content; }
.cal-day { width:32px; flex-shrink:0; display:flex; flex-direction:column; align-items:center; gap:3px; }
.cal-box { width:32px; height:32px; border-radius:7px; border:1.5px solid var(--gray-l); display:flex; align-items:center; justify-content:center; font-size:13px; background:var(--white); }
.cal-box.hit { background:var(--gold); border-color:var(--gold); color:#fff; }
.cal-box.today { border-color:var(--navy); border-width:2px; }
.cal-box.today.hit { background:var(--navy); border-color:var(--navy); color:#fff; }
.cal-box.fut { background:var(--gray-l); border-color:var(--gray-l); }
.cal-lbl { font-size:9px; color:var(--gray); font-weight:600; }
.cal-lbl.today { color:var(--navy); font-weight:700; }
.h-best { font-size:11px; color:var(--gold); font-weight:600; margin-top:8px; }

/* MIND DUMP */
.md-item { display:flex; align-items:flex-start; gap:10px; padding:11px; background:var(--cream); border-radius:var(--rs); margin-bottom:8px; }
.md-item.done { opacity:.5; }
.md-text { flex:1; font-size:14px; line-height:1.5; }
.md-text.done { text-decoration:line-through; color:var(--gray); }
.md-prio { font-size:10px; font-weight:600; padding:2px 7px; border-radius:99px; white-space:nowrap; }
.p-hi { background:#FEE2E2; color:#991B1B; }
.p-md { background:var(--warn); color:var(--warn-fg); }
.p-lo { background:var(--green-l); color:var(--green); }
.md-btn { width:28px; height:28px; border-radius:6px; border:none; background:var(--gray-l); color:var(--gray); cursor:pointer; font-size:13px; display:flex; align-items:center; justify-content:center; }
.prio-row { display:flex; gap:7px; margin-top:6px; }
.prio-btn { flex:1; padding:8px; border-radius:8px; border:1.5px solid var(--gray-l); background:var(--white); font-size:13px; font-weight:600; cursor:pointer; font-family:'DM Sans',sans-serif; }
.prio-btn.sel-hi { background:#FEE2E2; border-color:#991B1B; color:#991B1B; }
.prio-btn.sel-md { background:var(--warn); border-color:var(--warn-fg); color:var(--warn-fg); }
.prio-btn.sel-lo { background:var(--green-l); border-color:var(--green); color:var(--green); }

/* MODAL */
.modal-bg { position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:200; display:flex; align-items:flex-end; justify-content:center; }
.modal { background:var(--white); border-radius:var(--r) var(--r) 0 0; padding:22px; width:100%; max-width:600px; max-height:85vh; overflow-y:auto; }
.modal-title { font-family:'Playfair Display',serif; font-size:18px; font-weight:700; margin-bottom:14px; }
.ifield { width:100%; padding:11px; border:1.5px solid var(--gray-l); border-radius:var(--rs); font-family:'DM Sans',sans-serif; font-size:14px; color:var(--navy); outline:none; background:var(--cream); }
.ifield:focus { border-color:var(--gold); }
.emoji-grid { display:flex; flex-wrap:wrap; gap:7px; margin:8px 0; }
.eg-btn { width:38px; height:38px; border-radius:8px; border:1.5px solid var(--gray-l); background:var(--white); font-size:19px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
.eg-btn.active { border-color:var(--gold); background:var(--gold-l); }

/* MISC */
.celebrate { background:linear-gradient(135deg,var(--navy),var(--navy2)); border-radius:var(--r); padding:20px; text-align:center; color:#fff; margin-bottom:14px; }
.cel-icon { font-size:36px; margin-bottom:7px; }
.cel-title { font-family:'Playfair Display',serif; font-size:18px; color:var(--gold); font-weight:700; margin-bottom:3px; }
.cel-txt { font-size:13px; opacity:.75; }
.toast { position:fixed; bottom:80px; left:50%; transform:translateX(-50%) translateY(20px); background:var(--navy); color:#fff; padding:10px 20px; border-radius:99px; font-size:14px; font-weight:500; box-shadow:0 8px 32px rgba(27,42,74,.2); opacity:0; transition:all .3s; z-index:300; white-space:nowrap; pointer-events:none; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
.spin { width:28px; height:28px; border:3px solid var(--gray-l); border-top-color:var(--gold); border-radius:50%; animation:sp .8s linear infinite; }
@keyframes sp { to { transform:rotate(360deg); } }
.loading { display:flex; flex-direction:column; align-items:center; gap:10px; padding:32px; color:var(--gray); font-size:13px; }
.empty { text-align:center; padding:32px 16px; color:var(--gray); font-size:14px; }
.empty-icon { font-size:32px; margin-bottom:8px; }
.setup-step { display:flex; gap:12px; padding:10px 0; border-bottom:1px solid var(--gray-l); }
.setup-step:last-child { border-bottom:none; }
.s-num { width:26px; height:26px; min-width:26px; background:var(--navy); color:#fff; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:12px; font-weight:700; }
.s-txt { font-size:13px; line-height:1.6; flex:1; }
.s-txt code { background:var(--gray-l); padding:2px 5px; border-radius:4px; font-size:11px; }
.ifield2 { width:100%; padding:10px; border:1.5px solid var(--gray-l); border-radius:var(--rs); font-family:'DM Sans',sans-serif; font-size:14px; outline:none; background:var(--cream); margin-top:7px; }
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-row1">
    <div class="hdr-title">Lock-In 2025</div>
    <div class="hdr-streak" id="hdr-streak">ğŸ”¥ 0 gÃ¼n</div>
  </div>
  <div class="hdr-row2">
    <div class="hdr-datetime">
      <div class="hdr-date-txt" id="hdr-date">â€”</div>
      <div class="hdr-clock-txt" id="hdr-clock">00:00:00</div>
    </div>
    <div class="hdr-right">
      <div class="hdr-days-box">
        <div class="hdr-days-num" id="hdr-days">â€”</div>
        <div class="hdr-days-lbl">gÃ¼n kaldÄ±</div>
      </div>
      <div class="hdr-prog-box">
        <div class="hdr-prog-pct" id="hdr-prog-pct">%0</div>
        <div class="hdr-prog-bar"><div class="hdr-prog-fill" id="hdr-prog-fill"></div></div>
      </div>
    </div>
  </div>
</div>

<nav class="nav">
  <button class="nb active" onclick="showTab('bugun')">â˜€ï¸ BugÃ¼n</button>
  <button class="nb" onclick="showTab('minddump')">ğŸ§  Mind Dump</button>
  <button class="nb" onclick="showTab('zincir')">ğŸ”— Zinciri KÄ±rma</button>
  <button class="nb" onclick="showTab('wbs')">ğŸ“‹ WBS</button>
  <button class="nb" onclick="showTab('supplement')">ğŸ’Š Supplement</button>
  <button class="nb" onclick="showTab('kpi')">ğŸ“Š KPI</button>
  <button class="nb" onclick="showTab('ayarlar')">âš™ï¸ Ayarlar</button>
</nav>

<div class="main">

<!-- BUGÃœN -->
<div id="tab-bugun">
  <div id="cel-morning" class="celebrate" style="display:none">
    <div class="cel-icon">â˜€ï¸</div>
    <div class="cel-title">Sabah check-in tamam!</div>
    <div class="cel-txt">Harika bir gÃ¼n olsun.</div>
  </div>
  <div class="card" id="card-morning">
    <div class="card-title">â˜€ï¸ Sabah Check-In</div>
    <div class="slbl">Enerji Seviyeni SeÃ§</div>
    <div class="energy-row" id="energy-btns"></div>
    <div class="slbl">Rutin</div>
    <div class="ci" onclick="toggleCI(this,'water')"><div class="cb"></div><span class="cl">ğŸ’§ 1 bardak su iÃ§tim</span></div>
    <div class="ci" onclick="toggleCI(this,'affirmations')"><div class="cb"></div><span class="cl">âœ¨ AffirmationlarÄ±mÄ± okudum</span></div>
    <div class="ci" onclick="toggleCI(this,'journaling')"><div class="cb"></div><span class="cl">ğŸ““ Journaling yaptÄ±m</span></div>
    <div class="ci" onclick="toggleCI(this,'reading')"><div class="cb"></div><span class="cl">ğŸ“– Hollandaca okuma (15 dk)</span></div>
    <div class="ci" onclick="toggleCI(this,'supplement')"><div class="cb"></div><span class="cl">ğŸ’Š Sabah supplementlerimi aldÄ±m</span></div>
    <div style="margin-top:14px"><button class="btn btn-gold" onclick="saveMorning()">Sabah Check-In Kaydet</button></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“Œ BugÃ¼nÃ¼n Task'larÄ±</div>
    <div class="card-sub">WBS + Mind Dump'tan enerji skoruna gÃ¶re seÃ§ildi</div>
    <div id="today-tasks"><div class="loading"><div class="spin"></div><span>YÃ¼kleniyor...</span></div></div>
    <div style="margin-top:8px"><button class="btn btn-ghost btn-sm" onclick="refreshTasks()">ğŸ”„ Yeni Ã–ner</button></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸŒ™ AkÅŸam Check-In</div>
    <div class="slbl">Ã–z BakÄ±m</div>
    <div class="ci" onclick="toggleCI(this,'teeth')"><div class="cb"></div><span class="cl">ğŸ¦· DiÅŸ fÄ±rÃ§aladÄ±m</span></div>
    <div class="ci" onclick="toggleCI(this,'shower')"><div class="cb"></div><span class="cl">ğŸš¿ DuÅŸ aldÄ±m</span></div>
    <div style="margin-top:12px">
      <div class="slbl">BugÃ¼nÃ¼n En Ä°yi Åeyi</div>
      <textarea class="ifield" id="win-of-day" rows="2" placeholder="BugÃ¼n iyi giden 1 ÅŸey..."></textarea>
    </div>
    <div style="margin-top:10px"><button class="btn btn-navy" onclick="saveEvening()">AkÅŸam Check-In Kaydet</button></div>
  </div>
</div>

<!-- MIND DUMP -->
<div id="tab-minddump" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ§  Mind Dump</div>
    <div class="card-sub">AklÄ±ndaki her ÅŸeyi boÅŸalt. Ã–nemliler task olarak Ã¶nerilebilir.</div>
    <textarea class="ifield" id="md-input" rows="3" placeholder="Ne aklÄ±nda takÄ±lÄ±yor?"></textarea>
    <div class="slbl">Ã–ncelik</div>
    <div class="prio-row">
      <button class="prio-btn" id="pb-hi" onclick="setPrio('high')">ğŸ”´ YÃ¼ksek</button>
      <button class="prio-btn sel-md" id="pb-md" onclick="setPrio('med')">ğŸŸ¡ Orta</button>
      <button class="prio-btn" id="pb-lo" onclick="setPrio('low')">ğŸŸ¢ DÃ¼ÅŸÃ¼k</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-gold" onclick="addMD()">Ekle</button>
      <button class="btn btn-ghost btn-sm" onclick="addMDAsTask()">ğŸ² Task Yap</button>
    </div>
  </div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div class="card-title" style="margin-bottom:0">Liste</div>
      <div style="display:flex;gap:5px">
        <button class="btn btn-navy btn-sm" id="mdf-all" onclick="setMDFilter('all')">Hepsi</button>
        <button class="btn btn-ghost btn-sm" id="mdf-open" onclick="setMDFilter('open')">AÃ§Ä±k</button>
        <button class="btn btn-ghost btn-sm" id="mdf-done" onclick="setMDFilter('done')">Bitti</button>
      </div>
    </div>
    <div id="md-list"><div class="loading"><div class="spin"></div></div></div>
  </div>
</div>

<!-- ZÄ°NCÄ°RÄ° KIRMA -->
<div id="tab-zincir" style="display:none">
  <div class="z-hero">
    <div class="z-num" id="z-streak">0</div>
    <div class="z-info">
      <div class="z-lbl">ğŸ”¥ Aktif Streak</div>
      <div class="z-sub">Ortalama Ã¼st Ã¼ste gÃ¼n</div>
      <div class="z-rec" id="z-record">En uzun: 0 gÃ¼n</div>
    </div>
  </div>
  <div id="habit-list"><div class="loading"><div class="spin"></div></div></div>
  <button class="btn btn-gold" onclick="openAddHabit()" style="margin-top:4px">+ Yeni AlÄ±ÅŸkanlÄ±k</button>
</div>

<!-- WBS -->
<div id="tab-wbs" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ“‹ WBS â€” Proje Task'larÄ±</div>
    <div id="wbs-overall"></div>
  </div>
  <div id="wbs-list"><div class="loading"><div class="spin"></div></div></div>
</div>

<!-- SUPPLEMENT -->
<div id="tab-supplement" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ’Š Supplement ProtokolÃ¼</div>
    <div class="wbox">âš ï¸ YaÄŸlÄ± kapsÃ¼lleri (Omega-3, D3+K2, Resveratrol) asla aÃ§ karna alma. Mide bulantÄ±sÄ±nda o dozu atla.</div>
    <div id="suppl-content"></div>
  </div>
</div>

<!-- KPI -->
<div id="tab-kpi" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ“Š HaftalÄ±k KPI</div>
    <div class="card-sub">%70 ve Ã¼zeri = baÅŸarÄ±lÄ± hafta ğŸ‰</div>
    <div id="kpi-view"><div class="loading"><div class="spin"></div></div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“ KPI GÃ¼ncelle</div>
    <div id="kpi-form"></div>
    <button class="btn btn-navy" style="margin-top:12px" onclick="saveKPI()">KPI Kaydet</button>
  </div>
</div>

<!-- AYARLAR -->
<div id="tab-ayarlar" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ“± Telegram Bildirimleri</div>
    <div class="setup-step"><div class="s-num">1</div><div class="s-txt">Telegram'da <code>@BotFather</code> ara â†’ tÄ±kla.</div></div>
    <div class="setup-step"><div class="s-num">2</div><div class="s-txt"><code>/newbot</code> yaz â†’ isim ver â†’ token al.</div></div>
    <div class="setup-step"><div class="s-num">3</div><div class="s-txt">Bota bir mesaj at. Sonra tarayÄ±cÄ±da ÅŸunu aÃ§: <code>https://api.telegram.org/bot[TOKEN]/getUpdates</code> â†’ <code>"id"</code> sayÄ±sÄ±nÄ± bul = Chat ID.</div></div>
    <input class="ifield2" id="tg-token" placeholder="Bot Token">
    <input class="ifield2" id="tg-chatid" placeholder="Chat ID">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-navy btn-sm" onclick="saveTG()" style="flex:1">Kaydet</button>
      <button class="btn btn-ghost btn-sm" onclick="testTG()" style="flex:1">ğŸ“¨ Test</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“… Program</div>
    <div style="font-size:13px;color:var(--gray);line-height:2.2">
      ğŸŸ¢ <b>Faz 1:</b> 20 Åub â€“ 2 Mar<br>
      ğŸŸ¡ <b>Faz 2:</b> 3 â€“ 17 Mar<br>
      âœˆï¸ <b>TÃ¼rkiye:</b> 18 â€“ 24 Mar<br>
      ğŸ”µ <b>Faz 3:</b> 25 â€“ 31 Mar
    </div>
    <div style="margin-top:10px;padding:10px;background:var(--gold-l);border-radius:8px;font-size:13px;color:var(--navy);font-weight:500">ğŸ¯ Hedef: HaftalÄ±k task'larÄ±n %70'ini tamamla.</div>
  </div>
</div>

</div><!-- /main -->

<!-- HABIT MODAL -->
<div class="modal-bg" id="habit-modal" style="display:none" onclick="closeModalIfBg(event)">
  <div class="modal">
    <div class="modal-title" id="modal-title">Yeni AlÄ±ÅŸkanlÄ±k</div>
    <div class="slbl" style="margin-top:0">Ä°kon</div>
    <div class="emoji-grid" id="emoji-grid"></div>
    <div class="slbl">Ad</div>
    <input class="ifield" id="h-name" placeholder="Ã¶rn: Meditasyon">
    <div class="slbl">AÃ§Ä±klama</div>
    <input class="ifield" id="h-desc" placeholder="Ã¶rn: 10 dk sabah meditasyonu" style="margin-top:6px">
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-gold" onclick="saveHabit()" id="h-save-btn" style="flex:1">Kaydet</button>
      <button class="btn btn-ghost btn-sm" onclick="closeHabitModal()" style="flex:0.4">Ä°ptal</button>
    </div>
    <button class="btn btn-danger btn-sm" id="h-del-btn" style="display:none;width:100%;margin-top:8px" onclick="deleteHabit()">AlÄ±ÅŸkanlÄ±ÄŸÄ± Sil</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SURL = 'https://ucwgkduvpnklfggleupb.supabase.co';
const SKEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjd2drZHV2cG5rbGZnZ2xldXBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE1NzcsImV4cCI6MjA4NzE3NzU3N30.AKBjKoYp2xie6qd19crJVMIJDFzmXPTqU2BTtFHnypw';
const sb = supabase.createClient(SURL, SKEY);

const TABS = ['bugun','minddump','zincir','wbs','supplement','kpi','ayarlar'];
const EMOJIS = ['ğŸ’§','ğŸ’Š','ğŸ“–','ğŸ““','âœ¨','ğŸš¿','ğŸ¦·','ğŸƒ','ğŸ§˜','ğŸ¥—','ğŸŒ¿','ğŸ’ª','â˜•','ğŸ¯','ğŸ“š','âœï¸','ğŸ¸','ğŸ–¥ï¸','ğŸ§¹','ğŸ’¤','ğŸ§´','ğŸ’†','ğŸ‹ï¸','ğŸ¨'];
const DAY_NAMES = ['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
const MON_NAMES = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
const DAY_SHORT = ['Pz','Pt','Sa','Ã‡a','Pe','Cu','Ct'];
const DEADLINE = new Date('2026-04-01T00:00:00');

function getToday() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}

let TODAY = getToday();
let energy = 0;
let mChecks = {water:false,affirmations:false,journaling:false,reading:false,supplement:false};
let eChecks = {teeth:false,shower:false};
let editHabitId = null;
let selEmoji = EMOJIS[0];
let mdPrio = 'med';
let mdFilter = 'all';

// â”€â”€ INIT â”€â”€
window.addEventListener('DOMContentLoaded', async () => {
  initHeader();
  renderEnergyBtns();
  renderSupplement();
  renderKPIForm();
  await loadTodayCheckin();
  await loadTodayTasks();
  await calcStreak();
  await loadHeaderProgress();
});

// â”€â”€ HEADER â”€â”€
function initHeader() {
  updateDate();
  startClock();
  updateCountdown();
  setInterval(updateCountdown, 60000);
}

function updateDate() {
  const n = new Date();
  document.getElementById('hdr-date').textContent =
    DAY_NAMES[n.getDay()] + ', ' + n.getDate() + ' ' + MON_NAMES[n.getMonth()] + ' ' + n.getFullYear();
}

function startClock() {
  function tick() {
    const n = new Date();
    const h = String(n.getHours()).padStart(2,'0');
    const m = String(n.getMinutes()).padStart(2,'0');
    const s = String(n.getSeconds()).padStart(2,'0');
    document.getElementById('hdr-clock').textContent = h + ':' + m + ':' + s;
    TODAY = getToday();
  }
  tick();
  setInterval(tick, 1000);
}

function updateCountdown() {
  const now = new Date();
  const diff = Math.ceil((DEADLINE - now) / (1000 * 60 * 60 * 24));
  document.getElementById('hdr-days').textContent = diff > 0 ? diff : '0';
}

async function loadHeaderProgress() {
  try {
    const {data:cats} = await sb.from('wbs_categories').select('*, wbs_tasks(*, wbs_microtasks(*))');
    if (!cats) return;
    let total = 0, done = 0;
    cats.forEach(c => (c.wbs_tasks||[]).forEach(t => (t.wbs_microtasks||[]).forEach(m => { total++; if(m.is_completed) done++; })));
    const pct = total ? Math.round(done/total*100) : 0;
    document.getElementById('hdr-prog-fill').style.width = pct + '%';
    document.getElementById('hdr-prog-pct').textContent = '%' + pct;
  } catch(e) {}
}

// â”€â”€ TAB â”€â”€
function showTab(name) {
  TABS.forEach(t => document.getElementById('tab-'+t).style.display = t===name ? 'block' : 'none');
  document.querySelectorAll('.nb').forEach((b,i) => b.classList.toggle('active', TABS[i]===name));
  if (name==='wbs') loadWBS();
  if (name==='zincir') loadHabits();
  if (name==='supplement') renderSupplement();
  if (name==='kpi') loadKPI();
  if (name==='ayarlar') loadTGSettings();
  if (name==='minddump') loadMindDump();
}

// â”€â”€ ENERGY â”€â”€
function renderEnergyBtns() {
  const w = document.getElementById('energy-btns');
  w.innerHTML = '';
  for (let i=1; i<=10; i++) {
    const b = document.createElement('button');
    b.className = 'ebtn'; b.textContent = i;
    b.onclick = () => { energy = i; document.querySelectorAll('.ebtn').forEach((x,j) => x.classList.toggle('active', j+1===i)); };
    w.appendChild(b);
  }
}

// â”€â”€ CHECKIN â”€â”€
function toggleCI(el, key) {
  const box = el.querySelector('.cb');
  const lbl = el.querySelector('.cl');
  const wasDone = box.classList.contains('done');
  if (wasDone) {
    box.classList.remove('done'); box.textContent = ''; lbl.classList.remove('done');
    if (key in mChecks) mChecks[key] = false; else eChecks[key] = false;
  } else {
    box.classList.add('done'); box.textContent = 'âœ“'; lbl.classList.add('done');
    if (key in mChecks) mChecks[key] = true; else eChecks[key] = true;
  }
}

async function loadTodayCheckin() {
  try {
    const {data} = await sb.from('daily_checkins').select('*').eq('date', TODAY);
    if (!data || !data.length) return;
    const m = data.find(d => d.type==='morning');
    if (m) {
      document.getElementById('card-morning').style.display = 'none';
      document.getElementById('cel-morning').style.display = 'block';
      energy = m.energy_score || 0;
    }
    const e = data.find(d => d.type==='evening');
    if (e && e.win_of_day) document.getElementById('win-of-day').value = e.win_of_day;
  } catch(e) { console.error('loadTodayCheckin:', e); }
}

async function saveMorning() {
  if (!energy) { toast('Enerji skorunu seÃ§!'); return; }
  try {
    const {error} = await sb.from('daily_checkins').upsert({
      date: TODAY, type: 'morning', energy_score: energy,
      water_done: mChecks.water, affirmations_done: mChecks.affirmations,
      journaling_done: mChecks.journaling, reading_done: mChecks.reading,
      supplement_done: mChecks.supplement
    }, {onConflict: 'date,type'});
    if (error) throw error;
    toast('âœ… Sabah check-in kaydedildi!');
    document.getElementById('card-morning').style.display = 'none';
    document.getElementById('cel-morning').style.display = 'block';
    await loadTodayTasks(energy);
    await calcStreak();
    sendTG('â˜€ï¸ Sabah check-in tamam! Enerji: ' + energy + '/10');
  } catch(e) { toast('Hata: ' + e.message); }
}

async function saveEvening() {
  const win = document.getElementById('win-of-day').value;
  try {
    const {error} = await sb.from('daily_checkins').upsert({
      date: TODAY, type: 'evening',
      teeth_done: eChecks.teeth, shower_done: eChecks.shower, win_of_day: win
    }, {onConflict: 'date,type'});
    if (error) throw error;
    toast('ğŸŒ™ AkÅŸam check-in kaydedildi!');
    sendTG('ğŸŒ™ AkÅŸam check-in tamam! En iyi ÅŸey: ' + (win || 'â€”'));
  } catch(e) { toast('Hata: ' + e.message); }
}

// â”€â”€ TODAY TASKS â”€â”€
async function loadTodayTasks(energyScore) {
  const score = energyScore || energy || 5;
  const el = document.getElementById('today-tasks');
  el.innerHTML = '<div class="loading"><div class="spin"></div><span>YÃ¼kleniyor...</span></div>';

  try {
    // Check existing tasks
    const {data: existing} = await sb.from('daily_tasks')
      .select('id, status, source, microtask_id, mind_dump_id, wbs_microtasks(title, wbs_tasks(title, wbs_categories(label)))')
      .eq('date', TODAY);

    if (existing && existing.length > 0) {
      // Also fetch mind dump texts separately
      const mdIds = existing.filter(t => t.mind_dump_id).map(t => t.mind_dump_id);
      let mdTexts = {};
      if (mdIds.length > 0) {
        const {data: mdData} = await sb.from('mind_dump_items').select('id, text').in('id', mdIds);
        if (mdData) mdData.forEach(m => mdTexts[m.id] = m.text);
      }
      renderTasks(existing, mdTexts);
      return;
    }

    // Generate new tasks
    const count = score <= 4 ? 1 : 2;
    const {data: mts} = await sb.from('wbs_microtasks')
      .select('id, title, wbs_tasks(title, wbs_categories(label))')
      .eq('is_completed', false).limit(10);

    const inserts = [];
    if (mts && mts.length > 0) inserts.push({date: TODAY, microtask_id: mts[0].id, status: 'pending', source: 'wbs'});

    if (count >= 2) {
      // Try to add a mind dump task
      let added = false;
      try {
        const {data: mdItems} = await sb.from('mind_dump_items').select('id').eq('is_done', false).limit(5);
        if (mdItems && mdItems.length > 0) {
          const rand = mdItems[Math.floor(Math.random() * mdItems.length)];
          inserts.push({date: TODAY, mind_dump_id: rand.id, status: 'pending', source: 'minddump'});
          added = true;
        }
      } catch(e) {}
      if (!added && mts && mts.length > 1) {
        inserts.push({date: TODAY, microtask_id: mts[1].id, status: 'pending', source: 'wbs'});
      }
    }

    for (const ins of inserts) await sb.from('daily_tasks').insert(ins);

    const {data: newTasks} = await sb.from('daily_tasks')
      .select('id, status, source, microtask_id, mind_dump_id, wbs_microtasks(title, wbs_tasks(title, wbs_categories(label)))')
      .eq('date', TODAY);

    const mdIds2 = (newTasks||[]).filter(t => t.mind_dump_id).map(t => t.mind_dump_id);
    let mdTexts2 = {};
    if (mdIds2.length > 0) {
      try {
        const {data: mdData2} = await sb.from('mind_dump_items').select('id, text').in('id', mdIds2);
        if (mdData2) mdData2.forEach(m => mdTexts2[m.id] = m.text);
      } catch(e) {}
    }
    renderTasks(newTasks || [], mdTexts2);

  } catch(e) {
    console.error('loadTodayTasks error:', e);
    el.innerHTML = '<div class="empty"><div class="empty-icon">âš ï¸</div>YÃ¼klenemedi: ' + e.message + '</div>';
  }
}

async function refreshTasks() {
  try {
    await sb.from('daily_tasks').delete().eq('date', TODAY);
  } catch(e) {}
  await loadTodayTasks(energy);
}

function renderTasks(tasks, mdTexts) {
  mdTexts = mdTexts || {};
  const el = document.getElementById('today-tasks');
  if (!tasks.length) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Œ</div>Ã–nce sabah check-in yap</div>';
    return;
  }
  let h = '';
  tasks.forEach(t => {
    const isDone = t.status === 'done';
    const isPart = t.status === 'partial';
    const isMD = t.source === 'minddump';
    const title = isMD
      ? (mdTexts[t.mind_dump_id] || 'Mind Dump Task')
      : ((t.wbs_microtasks && t.wbs_microtasks.title) || 'â€”');
    const cat = isMD ? 'ğŸ§  Mind Dump'
      : ((t.wbs_microtasks && t.wbs_microtasks.wbs_tasks && t.wbs_microtasks.wbs_tasks.wbs_categories && t.wbs_microtasks.wbs_tasks.wbs_categories.label) || '');
    const badgeCls = isDone ? 'badge b-done' : isPart ? 'badge b-part' : 'badge b-pend';
    const badgeTxt = isDone ? 'âœ“ Bitti' : isPart ? '~ KÄ±smen' : 'Bekliyor';
    const micId = t.microtask_id || '';
    const mdId = t.mind_dump_id || '';
    h += '<div class="task-item' + (isDone ? ' done' : '') + '" onclick="cycleTask(\'' + t.id + '\',\'' + t.status + '\',\'' + t.source + '\',\'' + micId + '\',\'' + mdId + '\')">'
      + '<div class="task-check' + (isDone ? ' done' : '') + '">' + (isDone ? 'âœ“' : '') + '</div>'
      + '<div class="task-info"><div class="task-title">' + title + '</div><div class="task-cat">' + cat + '</div></div>'
      + '<span class="' + badgeCls + '">' + badgeTxt + '</span>'
      + '</div>';
  });
  el.innerHTML = h;
}

async function cycleTask(id, status, source, micId, mdId) {
  const next = status === 'pending' ? 'done' : status === 'done' ? 'partial' : 'pending';
  try {
    await sb.from('daily_tasks').update({status: next}).eq('id', id);
    if (next === 'done') {
      if (source === 'wbs' && micId && micId !== 'null' && micId !== '') {
        await sb.from('wbs_microtasks').update({is_completed: true, completed_at: new Date().toISOString()}).eq('id', micId);
        await loadHeaderProgress();
      }
      if (source === 'minddump' && mdId && mdId !== 'null' && mdId !== '') {
        try { await sb.from('mind_dump_items').update({is_done: true}).eq('id', mdId); } catch(e) {}
      }
      toast('âœ… Task tamamlandÄ±!');
    }
    await loadTodayTasks(energy);
    if (source === 'wbs') await loadHeaderProgress();
  } catch(e) { toast('Hata: ' + e.message); }
}

// â”€â”€ MIND DUMP â”€â”€
function setPrio(p) {
  mdPrio = p;
  document.getElementById('pb-hi').className = 'prio-btn' + (p==='high' ? ' sel-hi' : '');
  document.getElementById('pb-md').className = 'prio-btn' + (p==='med' ? ' sel-md' : '');
  document.getElementById('pb-lo').className = 'prio-btn' + (p==='low' ? ' sel-lo' : '');
}

async function addMD() {
  const text = document.getElementById('md-input').value.trim();
  if (!text) { toast('Bir ÅŸeyler yaz!'); return; }
  try {
    await sb.from('mind_dump_items').insert({text, priority: mdPrio, is_done: false});
    document.getElementById('md-input').value = '';
    toast('Mind dump eklendi!');
    await loadMindDump();
  } catch(e) { toast('Hata: ' + e.message); }
}

async function addMDAsTask() {
  const text = document.getElementById('md-input').value.trim();
  if (!text) { toast('Ã–nce bir ÅŸeyler yaz!'); return; }
  try {
    const {data: item} = await sb.from('mind_dump_items').insert({text, priority: mdPrio, is_done: false}).select().single();
    if (item) {
      await sb.from('daily_tasks').insert({date: TODAY, mind_dump_id: item.id, status: 'pending', source: 'minddump'});
      document.getElementById('md-input').value = '';
      toast('BugÃ¼nÃ¼n task\'Ä±na eklendi!');
      await loadMindDump();
      await loadTodayTasks(energy);
    }
  } catch(e) { toast('Hata: ' + e.message); }
}

function setMDFilter(f) {
  mdFilter = f;
  ['all','open','done'].forEach(x => {
    document.getElementById('mdf-'+x).className = 'btn btn-' + (x===f ? 'navy' : 'ghost') + ' btn-sm';
  });
  loadMindDump();
}

async function loadMindDump() {
  try {
    const {data} = await sb.from('mind_dump_items').select('*').order('created_at', {ascending: false});
    if (!data) return;
    let items = data;
    if (mdFilter === 'open') items = data.filter(d => !d.is_done);
    if (mdFilter === 'done') items = data.filter(d => d.is_done);
    const el = document.getElementById('md-list');
    if (!items.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ </div>HenÃ¼z hiÃ§bir ÅŸey yok.</div>'; return; }
    const pMap = {high:'ğŸ”´ YÃ¼ksek', med:'ğŸŸ¡ Orta', low:'ğŸŸ¢ DÃ¼ÅŸÃ¼k'};
    const pCls = {high:'md-prio p-hi', med:'md-prio p-md', low:'md-prio p-lo'};
    let h = '';
    items.forEach(item => {
      h += '<div class="md-item' + (item.is_done ? ' done' : '') + '">'
        + '<div class="md-text' + (item.is_done ? ' done' : '') + '">' + item.text + '</div>'
        + '<div style="display:flex;align-items:center;gap:5px;flex-shrink:0">'
        + (item.priority ? '<span class="' + (pCls[item.priority]||'md-prio') + '">' + (pMap[item.priority]||'') + '</span>' : '')
        + '<button class="md-btn" onclick="toggleMD(\'' + item.id + '\',' + item.is_done + ')">' + (item.is_done ? 'â†©' : 'âœ“') + '</button>'
        + '<button class="md-btn" onclick="deleteMD(\'' + item.id + '\')">âœ•</button>'
        + '</div></div>';
    });
    el.innerHTML = h;
  } catch(e) { document.getElementById('md-list').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}

async function toggleMD(id, isDone) {
  await sb.from('mind_dump_items').update({is_done: !isDone}).eq('id', id);
  await loadMindDump();
}
async function deleteMD(id) {
  await sb.from('mind_dump_items').delete().eq('id', id);
  toast('Silindi');
  await loadMindDump();
}

// â”€â”€ ZÄ°NCÄ°RÄ° KIRMA â”€â”€
async function loadHabits() {
  document.getElementById('habit-list').innerHTML = '<div class="loading"><div class="spin"></div></div>';
  try {
    await ensureDefaultHabits();
    const {data: habits} = await sb.from('habits').select('*').order('sort_order');
    if (!habits || !habits.length) {
      document.getElementById('habit-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸŒ±</div>HenÃ¼z alÄ±ÅŸkanlÄ±k yok.<br>YukarÄ±daki butona tÄ±kla!</div>';
      return;
    }
    const start = new Date(); start.setDate(start.getDate() - 27);
    const startStr = start.toISOString().split('T')[0];
    const {data: logs} = await sb.from('habit_logs').select('habit_id, date').gte('date', startStr);

    let html = '', totalStreak = 0, longestAll = 0;
    for (const h of habits) {
      const hLogs = (logs||[]).filter(l => l.habit_id === h.id);
      const {streak, longest, days} = calcHabitStats(hLogs);
      totalStreak += streak;
      if (longest > longestAll) longestAll = longest;
      html += buildHabitCard(h, streak, longest, days);
    }
    document.getElementById('habit-list').innerHTML = html;
    const avg = habits.length > 0 ? Math.round(totalStreak / habits.length) : 0;
    document.getElementById('z-streak').textContent = avg;
    document.getElementById('z-record').textContent = 'En uzun: ' + longestAll + ' gÃ¼n';
    document.getElementById('hdr-streak').textContent = 'ğŸ”¥ ' + avg + ' gÃ¼n';
  } catch(e) { document.getElementById('habit-list').innerHTML = '<div class="empty">YÃ¼klenemedi: ' + e.message + '</div>'; }
}

async function ensureDefaultHabits() {
  const {data} = await sb.from('habits').select('id').limit(1);
  if (data && data.length) return;
  const defaults = [
    {icon:'ğŸ’§',name:'Su â€” 2.5L',description:'GÃ¼nlÃ¼k hedef',sort_order:1},
    {icon:'ğŸ’Š',name:'Supplement',description:'Sabah protokolÃ¼',sort_order:2},
    {icon:'âœ¨',name:'Affirmations',description:'Sesli okuma',sort_order:3},
    {icon:'ğŸ““',name:'Journaling',description:'3 ÅŸÃ¼kran + niyet',sort_order:4},
    {icon:'ğŸ“–',name:'Hollandaca Okuma',description:'15 dk',sort_order:5},
    {icon:'ğŸ¦·',name:'DiÅŸ FÄ±rÃ§alama',description:'Sabah + akÅŸam',sort_order:6},
    {icon:'ğŸš¿',name:'DuÅŸ',description:'Haftada min 3',sort_order:7},
  ];
  for (const d of defaults) await sb.from('habits').insert(d);
}

function calcHabitStats(logs) {
  const days = {};
  logs.forEach(l => days[l.date] = true);
  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const ds = d.toISOString().split('T')[0];
    if (days[ds]) { streak++; d.setDate(d.getDate()-1); }
    else break;
  }
  const sorted = Object.keys(days).sort();
  let longest = 0, cur = 0, prev = null;
  sorted.forEach(ds => {
    if (prev) {
      const diff = Math.round((new Date(ds) - new Date(prev)) / 86400000);
      cur = diff === 1 ? cur + 1 : 1;
    } else { cur = 1; }
    if (cur > longest) longest = cur;
    prev = ds;
  });
  return {streak, longest, days};
}

function buildHabitCard(h, streak, longest, days) {
  const todayDone = days[TODAY] || false;
  let cal = '';
  for (let i = 27; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate() - i);
    const ds = d.toISOString().split('T')[0];
    const isToday = ds === TODAY;
    const isFut = ds > TODAY;
    const hit = days[ds] || false;
    let cls = 'cal-box';
    if (hit) cls += ' hit';
    if (isToday) cls += ' today';
    if (isFut) cls += ' fut';
    cal += '<div class="cal-day"><div class="' + cls + '">' + (hit ? 'âœ“' : '') + '</div>'
      + '<div class="cal-lbl' + (isToday ? ' today' : '') + '">' + DAY_SHORT[d.getDay()] + '</div></div>';
  }
  const hid = h.id;
  const ename = h.name.replace(/'/g,"&apos;");
  const edesc = (h.description||'').replace(/'/g,"&apos;");
  return '<div class="h-card">'
    + '<div class="h-top">'
    + '<div class="h-icon">' + h.icon + '</div>'
    + '<div class="h-info"><div class="h-name">' + h.name + '</div><div class="h-sub">' + (h.description||'') + '</div></div>'
    + '<div class="h-streak"><div class="h-s-num">' + streak + '</div><div class="h-s-lbl">streak</div></div>'
    + '<button class="tick-btn' + (todayDone ? ' done' : '') + '" onclick="tickHabit(\'' + hid + '\',' + todayDone + ')">' + (todayDone ? 'âœ“' : 'â—‹') + '</button>'
    + '<button class="edit-btn" onclick="openEditHabit(\'' + hid + '\',\'' + h.icon + '\',\'' + ename + '\',\'' + edesc + '\')">âœï¸</button>'
    + '</div>'
    + '<div class="cal-wrap"><div class="cal-row">' + cal + '</div></div>'
    + '<div class="h-best">ğŸ† En uzun streak: ' + longest + ' gÃ¼n</div>'
    + '</div>';
}

async function tickHabit(hid, isDone) {
  try {
    if (isDone) {
      await sb.from('habit_logs').delete().eq('habit_id', hid).eq('date', TODAY);
      toast('GÃ¼n iptal edildi');
    } else {
      await sb.from('habit_logs').upsert({habit_id: hid, date: TODAY}, {onConflict: 'habit_id,date'});
      toast('Harika! Zincir devam ediyor ğŸ”¥');
    }
    await loadHabits();
  } catch(e) { toast('Hata: ' + e.message); }
}

// â”€â”€ HABIT MODAL â”€â”€
function renderEmojiGrid() {
  document.getElementById('emoji-grid').innerHTML = EMOJIS.map(e =>
    '<button class="eg-btn' + (e===selEmoji ? ' active' : '') + '" onclick="selEmojiClick(\'' + e + '\')">' + e + '</button>'
  ).join('');
}
function selEmojiClick(e) { selEmoji = e; renderEmojiGrid(); }

function openAddHabit() {
  editHabitId = null; selEmoji = EMOJIS[0];
  document.getElementById('modal-title').textContent = 'Yeni AlÄ±ÅŸkanlÄ±k';
  document.getElementById('h-name').value = '';
  document.getElementById('h-desc').value = '';
  document.getElementById('h-del-btn').style.display = 'none';
  document.getElementById('h-save-btn').textContent = 'Kaydet';
  renderEmojiGrid();
  document.getElementById('habit-modal').style.display = 'flex';
}

function openEditHabit(id, icon, name, desc) {
  editHabitId = id; selEmoji = icon;
  document.getElementById('modal-title').textContent = 'DÃ¼zenle';
  document.getElementById('h-name').value = name;
  document.getElementById('h-desc').value = desc;
  document.getElementById('h-del-btn').style.display = 'block';
  document.getElementById('h-save-btn').textContent = 'GÃ¼ncelle';
  renderEmojiGrid();
  document.getElementById('habit-modal').style.display = 'flex';
}

function closeHabitModal() { document.getElementById('habit-modal').style.display = 'none'; }
function closeModalIfBg(ev) { if (ev.target === document.getElementById('habit-modal')) closeHabitModal(); }

async function saveHabit() {
  const name = document.getElementById('h-name').value.trim();
  if (!name) { toast('Ad gir!'); return; }
  const desc = document.getElementById('h-desc').value.trim();
  try {
    if (editHabitId) {
      await sb.from('habits').update({icon: selEmoji, name, description: desc}).eq('id', editHabitId);
      toast('GÃ¼ncellendi!');
    } else {
      const {data: ex} = await sb.from('habits').select('sort_order').order('sort_order', {ascending: false}).limit(1);
      const next = (ex && ex.length ? ex[0].sort_order : 0) + 1;
      await sb.from('habits').insert({icon: selEmoji, name, description: desc, sort_order: next});
      toast('AlÄ±ÅŸkanlÄ±k eklendi!');
    }
    closeHabitModal();
    await loadHabits();
  } catch(e) { toast('Hata: ' + e.message); }
}

async function deleteHabit() {
  if (!editHabitId) return;
  if (!confirm('Silmek istediÄŸine emin misin?')) return;
  try {
    await sb.from('habit_logs').delete().eq('habit_id', editHabitId);
    await sb.from('habits').delete().eq('id', editHabitId);
    closeHabitModal();
    toast('Silindi');
    await loadHabits();
  } catch(e) { toast('Hata: ' + e.message); }
}

// â”€â”€ WBS â”€â”€
async function loadWBS() {
  try {
    const {data: cats} = await sb.from('wbs_categories').select('*, wbs_tasks(*, wbs_microtasks(*))').order('sort_order');
    if (!cats) return;
    let total = 0, done = 0;
    cats.forEach(c => (c.wbs_tasks||[]).forEach(t => (t.wbs_microtasks||[]).forEach(m => { total++; if(m.is_completed) done++; })));
    const pct = total ? Math.round(done/total*100) : 0;
    document.getElementById('wbs-overall').innerHTML =
      '<div class="pbw"><div class="pbf" style="width:' + pct + '%"></div></div>'
      + '<div class="plbl"><span>Genel ilerleme</span><span>' + done + '/' + total + ' (%' + pct + ')</span></div>';
    document.getElementById('hdr-prog-fill').style.width = pct + '%';
    document.getElementById('hdr-prog-pct').textContent = '%' + pct;

    let html = '';
    cats.forEach(cat => {
      const tasks = cat.wbs_tasks || [];
      let ct = 0, cd = 0;
      tasks.forEach(t => (t.wbs_microtasks||[]).forEach(m => { ct++; if(m.is_completed) cd++; }));
      const cp = ct ? Math.round(cd/ct*100) : 0;
      let th = '';
      tasks.forEach(task => {
        const ms = task.wbs_microtasks || [];
        const allDone = ms.length > 0 && ms.every(m => m.is_completed);
        let mh = '';
        ms.forEach(m => {
          mh += '<div class="mt-row" onclick="toggleMicro(\'' + m.id + '\',' + m.is_completed + ')">'
            + '<div class="mt-check' + (m.is_completed ? ' done' : '') + '">' + (m.is_completed ? 'âœ“' : '') + '</div>'
            + '<span class="mt-lbl' + (m.is_completed ? ' done' : '') + '">' + m.title + '</span></div>';
        });
        th += '<div class="task-group"><div class="wbs-task' + (allDone ? ' done' : '') + '"><span>' + (allDone ? 'âœ…' : 'â—‹') + '</span>' + task.title + '</div>' + mh + '</div>';
      });
      html += '<div class="card"><div class="cat-hdr" onclick="toggleCat(\'wc-' + cat.id + '\')">'
        + '<div class="cat-name">' + cat.label + '</div>'
        + '<div class="cat-prog">' + cd + '/' + ct + ' Â· %' + cp + '</div></div>'
        + '<div class="pbw"><div class="pbf" style="width:' + cp + '%"></div></div>'
        + '<div id="wc-' + cat.id + '" style="margin-top:8px">' + th + '</div></div>';
    });
    document.getElementById('wbs-list').innerHTML = html;
  } catch(e) { document.getElementById('wbs-list').innerHTML = '<div class="empty">YÃ¼klenemedi: ' + e.message + '</div>'; }
}

function toggleCat(id) {
  const el = document.getElementById(id);
  el.style.display = el.style.display === 'none' ? 'block' : 'none';
}

async function toggleMicro(id, cur) {
  try {
    await sb.from('wbs_microtasks').update({is_completed: !cur, completed_at: !cur ? new Date().toISOString() : null}).eq('id', id);
    if (!cur) toast('âœ… TamamlandÄ±!');
    await loadWBS();
  } catch(e) { toast('Hata: ' + e.message); }
}

// â”€â”€ SUPPLEMENT â”€â”€
function renderSupplement() {
  const day = new Date().getDay();
  const typeMap = {1:'pzt',2:'pzt',3:'pzt',4:'inj',5:'fri',6:'sat',0:'sun'};
  const type = typeMap[day];
  const plans = {
    pzt: [{t:'Sabah (yemekle)',i:'D3+K2, Omega-3, B-Complex, Resveratrol',n:'YaÄŸlÄ± kapsÃ¼ller â€” mutlaka yemekle'},{t:'Ara Ã¶ÄŸÃ¼n',i:'Kolajen + C vitamini',n:''},{t:'Ã–ÄŸlen',i:'Creatine 3g',n:'BÃ¼yÃ¼k bardak suyla'},{t:'AkÅŸam',i:'Magnesium + Zinc',n:'AkÅŸam yemeÄŸiyle'}],
    inj: [{t:'Sabah',i:'D3+K2, Omega-3, B-Complex',n:'âš ï¸ Resveratrol isteÄŸe baÄŸlÄ±'},{t:'GÃ¼n iÃ§i',i:'Kolajen (hafif Ã¶ÄŸÃ¼nle)',n:'Creatine mide sorun yoksa'},{t:'AkÅŸam',i:'Enjeksiyon + Magnesium',n:'Zinc atlanabilir'}],
    fri: [{t:'Sabah',i:'D3+K2, Omega-3, B-Complex',n:'ğŸ”´ En hassas gÃ¼n'},{t:'Ã–ÄŸlen',i:'Creatine (kaydÄ±rÄ±lmÄ±ÅŸ)',n:'KÃ¼Ã§Ã¼k porsiyon'},{t:'AkÅŸam',i:'Magnesium',n:'Zinc atla'},{t:'TÃ¼m gÃ¼n',i:'Su + elektrolit artÄ±r',n:''}],
    sat: [{t:'Sabah',i:'D3+K2, Omega-3, B-Complex',n:'KÃ¼Ã§Ã¼k Ã¶ÄŸÃ¼nle'},{t:'GÃ¼n iÃ§i',i:'Kolajen + Creatine',n:'BÃ¶lerek al'},{t:'AkÅŸam',i:'Magnesium + Zinc',n:''}],
    sun: [{t:'Sabah (yemekle)',i:'D3+K2, Omega-3, B-Complex, Resveratrol',n:''},{t:'Ara Ã¶ÄŸÃ¼n',i:'Kolajen + C vitamini',n:''},{t:'Ã–ÄŸlen',i:'Creatine 3g',n:''},{t:'AkÅŸam',i:'Magnesium + Zinc',n:''}]
  };
  const tLabel = {pzt:'Stabil GÃ¼n âœ…',inj:'Enjeksiyon GÃ¼nÃ¼ âš ï¸',fri:'En Hassas GÃ¼n ğŸ”´',sat:'Normal GÃ¼n',sun:'Normal GÃ¼n'};
  let h = '<div class="s-day">' + DAY_NAMES[day] + ' â€” ' + tLabel[type] + '</div>';
  plans[type].forEach(p => {
    h += '<div class="s-row"><div class="s-time">' + p.t + '</div><div><div class="s-items">' + p.i + '</div>' + (p.n ? '<div class="s-note">' + p.n + '</div>' : '') + '</div></div>';
  });
  document.getElementById('suppl-content').innerHTML = h;
}

// â”€â”€ KPI â”€â”€
async function loadKPI() {
  try {
    const mon = getMonday();
    const {data} = await sb.from('weekly_kpi').select('*').eq('week_start', mon).maybeSingle();
    if (!data) { document.getElementById('kpi-view').innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div>Bu hafta henÃ¼z KPI girilmedi.</div>'; return; }
    const s = data.microtask_completion_pct || 0;
    document.getElementById('kpi-view').innerHTML =
      (s >= 70 ? '<div class="celebrate" style="margin-bottom:12px"><div class="cel-icon">ğŸ‰</div><div class="cel-title">BaÅŸarÄ±lÄ± Hafta!</div><div class="cel-txt">%' + s + ' tamamlandÄ±</div></div>' : '')
      + '<div class="kpi-grid">'
      + '<div class="kpi-card"><div class="kpi-val">%' + s + '</div><div class="kpi-lbl">Task Tamamlama</div><div class="kpi-tgt">â‰¥%70</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.water_days||0) + '/7</div><div class="kpi-lbl">Su 2.5L</div><div class="kpi-tgt">7/7</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">%' + (data.supplement_pct||0) + '</div><div class="kpi-lbl">Supplement</div><div class="kpi-tgt">â‰¥%80</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.reels_published||0) + '</div><div class="kpi-lbl">Reels</div><div class="kpi-tgt">3/hafta</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.ig_reach_change||0) + '%</div><div class="kpi-lbl">IG Reach</div><div class="kpi-tgt">>%20</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.ig_saves||0) + '</div><div class="kpi-lbl">IG Saves</div><div class="kpi-tgt">â†‘</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.energy_avg||0) + '</div><div class="kpi-lbl">Enerji Ort.</div><div class="kpi-tgt">â‰¥6</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">%' + (data.habit_compliance_pct||0) + '</div><div class="kpi-lbl">Rutin Uyum</div><div class="kpi-tgt">â‰¥%70</div></div>'
      + '</div>';
  } catch(e) { document.getElementById('kpi-view').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}

function renderKPIForm() {
  const fields = [
    {id:'kf-task',l:'Task Tamamlama %'},{id:'kf-water',l:'Su 2.5L GÃ¼nleri (0-7)'},
    {id:'kf-suppl',l:'Supplement Uyum %'},{id:'kf-reels',l:'Reels SayÄ±sÄ±'},
    {id:'kf-reach',l:'IG Reach ArtÄ±ÅŸÄ± %'},{id:'kf-saves',l:'IG Saves'},
    {id:'kf-energy',l:'Enerji OrtalamasÄ±'},{id:'kf-habit',l:'Rutin Uyum %'}
  ];
  document.getElementById('kpi-form').innerHTML = fields.map(f =>
    '<div style="margin-bottom:8px"><div style="font-size:12px;color:var(--gray);font-weight:600;margin-bottom:3px">' + f.l + '</div>'
    + '<input type="number" id="' + f.id + '" class="ifield"></div>'
  ).join('');
}

async function saveKPI() {
  const g = id => +(document.getElementById(id).value || 0);
  try {
    await sb.from('weekly_kpi').upsert({
      week_start: getMonday(),
      microtask_completion_pct: g('kf-task'), water_days: g('kf-water'),
      supplement_pct: g('kf-suppl'), reels_published: g('kf-reels'),
      ig_reach_change: g('kf-reach'), ig_saves: g('kf-saves'),
      energy_avg: g('kf-energy'), habit_compliance_pct: g('kf-habit')
    }, {onConflict: 'week_start'});
    toast('ğŸ“Š KPI kaydedildi!');
    await loadKPI();
  } catch(e) { toast('Hata: ' + e.message); }
}

// â”€â”€ STREAK â”€â”€
async function calcStreak() {
  try {
    const {data} = await sb.from('daily_checkins').select('date').eq('type','morning').order('date', {ascending: false}).limit(60);
    if (!data || !data.length) return;
    let streak = 0;
    const base = new Date(); base.setHours(0,0,0,0);
    for (let i = 0; i < data.length; i++) {
      const exp = new Date(base); exp.setDate(base.getDate() - i);
      const expStr = exp.toISOString().split('T')[0];
      if (data[i].date === expStr) streak++; else break;
    }
    document.getElementById('hdr-streak').textContent = 'ğŸ”¥ ' + streak + ' gÃ¼n';
  } catch(e) {}
}

// â”€â”€ TELEGRAM â”€â”€
async function loadTGSettings() {
  try {
    const {data} = await sb.from('notification_settings').select('*').limit(1).maybeSingle();
    if (data) {
      if (data.telegram_bot_token) document.getElementById('tg-token').value = data.telegram_bot_token;
      if (data.telegram_chat_id) document.getElementById('tg-chatid').value = data.telegram_chat_id;
    }
  } catch(e) {}
}
async function saveTG() {
  const token = document.getElementById('tg-token').value.trim();
  const chatId = document.getElementById('tg-chatid').value.trim();
  if (!token || !chatId) { toast('Token ve Chat ID gerekli!'); return; }
  try {
    const {data: ex} = await sb.from('notification_settings').select('id').limit(1).maybeSingle();
    if (ex) await sb.from('notification_settings').update({telegram_bot_token: token, telegram_chat_id: chatId}).eq('id', ex.id);
    else await sb.from('notification_settings').insert({telegram_bot_token: token, telegram_chat_id: chatId});
    toast('âœ… Telegram kaydedildi!');
  } catch(e) { toast('Hata: ' + e.message); }
}
async function testTG() {
  const token = document.getElementById('tg-token').value.trim();
  const chatId = document.getElementById('tg-chatid').value.trim();
  if (!token || !chatId) { toast('Ã–nce token ve Chat ID gir!'); return; }
  try {
    const r = await fetch('https://api.telegram.org/bot' + token + '/sendMessage', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({chat_id: chatId, text: 'ğŸ”’ Lock-In 2025 baÄŸlantÄ±sÄ± kuruldu!'})
    });
    const d = await r.json();
    toast(d.ok ? 'âœ… Test mesajÄ± gÃ¶nderildi!' : 'Hata: ' + d.description);
  } catch(e) { toast('BaÄŸlantÄ± hatasÄ±'); }
}
async function sendTG(text) {
  try {
    const {data} = await sb.from('notification_settings').select('*').limit(1).maybeSingle();
    if (!data || !data.telegram_bot_token) return;
    await fetch('https://api.telegram.org/bot' + data.telegram_bot_token + '/sendMessage', {
      method: 'POST', headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({chat_id: data.telegram_chat_id, text})
    });
  } catch(e) {}
}

// â”€â”€ UTILS â”€â”€
function getMonday() {
  const d = new Date(); const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  d.setDate(diff); return d.toISOString().split('T')[0];
}
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
</script>
</body>
</html>
