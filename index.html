<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>Lock-In 2025</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root{
  --navy:#1B2A4A;--navy2:#243560;--gold:#B8962E;--gold-l:#F5EDD6;
  --cream:#FAF8F3;--white:#fff;--gray:#6B7280;--gray-l:#F3F4F6;
  --green:#2D6A2D;--green-l:#EAF4EA;--warn:#FFF3CD;--warn-fg:#7D5A00;
  --red:#DC2626;--red-l:#FEE2E2;--r:16px;--rs:10px;
  --sh:0 4px 24px rgba(27,42,74,.10);
}
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{font-family:'DM Sans',sans-serif;background:var(--cream);color:var(--navy);min-height:100vh}

/* HEADER */
.hdr{background:var(--navy);padding:14px 18px 12px;position:sticky;top:0;z-index:100}
.hdr-r1{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
.hdr-title{font-family:'Playfair Display',serif;color:var(--gold);font-size:20px;font-weight:700}
.hdr-streak{background:var(--gold);color:var(--navy);border-radius:20px;padding:4px 12px;font-size:13px;font-weight:600}
.hdr-r2{display:flex;align-items:center;justify-content:space-between;gap:8px}
.hdr-datetime{flex:1}
.hdr-date-txt{color:rgba(255,255,255,.65);font-size:12px;font-weight:500}
.hdr-clock-txt{color:var(--gold);font-family:'Playfair Display',serif;font-size:15px;margin-top:1px}
.hdr-right{display:flex;align-items:center;gap:10px}
.hdr-days-box{background:rgba(255,255,255,.1);border-radius:8px;padding:6px 10px;text-align:center}
.hdr-days-num{color:var(--gold);font-family:'Playfair Display',serif;font-size:20px;font-weight:700;line-height:1}
.hdr-days-lbl{color:rgba(255,255,255,.5);font-size:9px;margin-top:1px}
.hdr-prog-box{text-align:right}
.hdr-prog-pct{color:rgba(255,255,255,.8);font-size:12px;font-weight:600;margin-bottom:3px}
.hdr-prog-bar{width:80px;height:5px;background:rgba(255,255,255,.15);border-radius:99px;overflow:hidden}
.hdr-prog-fill{height:100%;background:var(--gold);border-radius:99px;transition:width .5s;width:0%}

/* NAV */
.nav{background:var(--white);border-bottom:1px solid rgba(27,42,74,.08);display:flex;overflow-x:auto;scrollbar-width:none;position:sticky;top:88px;z-index:99}
.nav::-webkit-scrollbar{display:none}
.nb{padding:13px 14px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:500;color:var(--gray);border:none;background:none;cursor:pointer;white-space:nowrap;border-bottom:2px solid transparent;transition:all .2s}
.nb.act{color:var(--navy);border-bottom-color:var(--gold);font-weight:600}

/* LAYOUT */
.main{padding:16px 16px 120px;max-width:600px;margin:0 auto}
.card{background:var(--white);border-radius:var(--r);padding:18px;margin-bottom:14px;box-shadow:var(--sh)}
.card-title{font-family:'Playfair Display',serif;font-size:17px;font-weight:700;color:var(--navy);margin-bottom:14px}
.slbl{font-size:11px;font-weight:600;color:var(--gray);text-transform:uppercase;letter-spacing:1px;margin:14px 0 8px}
.slbl:first-child{margin-top:0}

/* BUTTONS */
.btn{padding:12px 18px;border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:14px;font-weight:600;cursor:pointer;border:none;transition:all .2s;display:inline-flex;align-items:center;justify-content:center;gap:8px;width:100%}
.btn-gold{background:var(--gold);color:var(--navy)}
.btn-navy{background:var(--navy);color:#fff}
.btn-ghost{background:var(--gray-l);color:var(--navy)}
.btn-red{background:var(--red-l);color:var(--red)}
.btn-sm{padding:7px 13px;font-size:13px;border-radius:8px;width:auto}

/* CHECKLIST */
.ci{display:flex;align-items:center;gap:12px;padding:11px 0;border-bottom:1px solid var(--gray-l);cursor:pointer;user-select:none}
.ci:last-child{border-bottom:none}
.ci.ro{pointer-events:none;opacity:.65}
.cb{width:22px;height:22px;min-width:22px;border:2px solid var(--gray-l);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .2s}
.cb.done{background:var(--green);border-color:var(--green);color:#fff}
.cl{font-size:14px;flex:1}
.cl.done{color:var(--gray);text-decoration:line-through}

/* ENERGY BTNS */
.energy-row{display:flex;gap:6px;flex-wrap:wrap}
.ebtn{width:38px;height:38px;border-radius:50%;border:2px solid var(--gray-l);background:var(--white);font-size:13px;font-weight:600;color:var(--gray);cursor:pointer;transition:all .2s;font-family:'DM Sans',sans-serif}
.ebtn.act{background:var(--navy);border-color:var(--navy);color:#fff}
.ebtn:disabled{opacity:.5;cursor:default}

/* TASKS */
.task-item{display:flex;align-items:center;gap:11px;padding:12px;background:var(--cream);border-radius:var(--rs);margin-bottom:8px;cursor:pointer;border:1.5px solid transparent;transition:all .2s}
.task-item:hover{border-color:var(--gold-l)}
.task-item.done{opacity:.55}
.task-check{width:24px;height:24px;min-width:24px;border:2px solid var(--gray-l);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:13px;transition:all .2s}
.task-check.done{background:var(--green);border-color:var(--green);color:#fff}
.task-info{flex:1}
.task-title{font-size:14px;font-weight:500}
.task-cat{font-size:12px;color:var(--gray);margin-top:2px}
.badge{font-size:11px;font-weight:600;padding:3px 8px;border-radius:99px}
.b-pend{background:var(--gray-l);color:var(--gray)}
.b-done{background:var(--green-l);color:var(--green)}
.b-part{background:var(--warn);color:var(--warn-fg)}

/* PROGRESS */
.pbw{background:var(--gray-l);border-radius:99px;height:7px;overflow:hidden;margin:8px 0 3px}
.pbf{height:100%;background:linear-gradient(90deg,var(--gold),var(--navy));border-radius:99px;transition:width .5s}
.plbl{font-size:12px;color:var(--gray);display:flex;justify-content:space-between}

/* HABITS */
.h-card{background:var(--white);border-radius:var(--r);padding:16px;margin-bottom:12px;box-shadow:var(--sh)}
.h-top{display:flex;align-items:center;gap:11px;margin-bottom:12px}
.h-icon{font-size:24px;width:36px;text-align:center}
.h-info{flex:1}
.h-name{font-size:15px;font-weight:600}
.h-sub{font-size:12px;color:var(--gray);margin-top:2px}
.h-streak{text-align:right}
.h-s-num{font-family:'Playfair Display',serif;font-size:30px;font-weight:700;color:var(--gold);line-height:1}
.h-s-lbl{font-size:10px;color:var(--gray)}
.tick-btn{width:38px;height:38px;min-width:38px;border-radius:50%;border:2px solid var(--gray-l);background:var(--white);font-size:18px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s}
.tick-btn.done{background:var(--green);border-color:var(--green);color:#fff}
.edit-btn{width:32px;height:32px;min-width:32px;border-radius:50%;border:1.5px solid var(--gray-l);background:var(--white);font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center}

/* CALENDAR */
.cal-wrap{overflow-x:auto;padding-bottom:2px}
.cal-row{display:flex;gap:4px;min-width:max-content}
.cal-day{width:32px;flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:3px}
.cal-box{width:32px;height:32px;border-radius:7px;border:1.5px solid var(--gray-l);display:flex;align-items:center;justify-content:center;font-size:13px;background:var(--white)}
.cal-box.hit{background:var(--gold);border-color:var(--gold);color:#fff}
.cal-box.today{border-color:var(--navy);border-width:2px}
.cal-box.today.hit{background:var(--navy);border-color:var(--navy);color:#fff}
.cal-box.fut{background:var(--gray-l);border-color:var(--gray-l)}
.cal-lbl{font-size:9px;color:var(--gray);font-weight:600}
.cal-lbl.today{color:var(--navy);font-weight:700}
.h-best{font-size:11px;color:var(--gold);font-weight:600;margin-top:8px}

/* COUNTER */
.counter-row{display:flex;align-items:center;gap:8px;margin-top:6px}
.cnt-btn{width:32px;height:32px;border-radius:50%;border:2px solid var(--gray-l);background:var(--white);font-size:20px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:center;color:var(--navy)}
.cnt-val{font-family:'Playfair Display',serif;font-size:22px;font-weight:700;color:var(--navy);min-width:50px;text-align:center}
.cnt-unit{font-size:12px;color:var(--gray)}

/* WBS */
.cat-hdr{display:flex;align-items:center;justify-content:space-between;padding:11px 0 8px;cursor:pointer}
.cat-name{font-family:'Playfair Display',serif;font-size:16px;font-weight:700}
.cat-prog{font-size:12px;color:var(--gray);background:var(--gray-l);padding:3px 9px;border-radius:20px}
.task-group{border-left:3px solid var(--gold-l);margin:0 0 10px 6px;padding-left:14px}
.wbs-task{font-size:14px;font-weight:600;padding:8px 0 5px;display:flex;align-items:center;gap:7px}
.wbs-task.done{color:var(--gray)}
.mt-row{display:flex;align-items:center;gap:9px;padding:7px 0;border-bottom:1px solid rgba(27,42,74,.05);cursor:pointer}
.mt-row:last-child{border-bottom:none}
.mt-check{width:17px;height:17px;min-width:17px;border:2px solid var(--gray-l);border-radius:4px;display:flex;align-items:center;justify-content:center;font-size:10px;transition:all .2s}
.mt-check.done{background:var(--gold);border-color:var(--gold);color:#fff}
.mt-lbl{font-size:13px;flex:1}
.mt-lbl.done{color:var(--gray);text-decoration:line-through}

/* SUPPLEMENT */
.suppl-item{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--gray-l);cursor:pointer;user-select:none}
.suppl-item:last-child{border-bottom:none}
.suppl-cb{width:22px;height:22px;min-width:22px;border:2px solid var(--gray-l);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:12px;transition:all .2s}
.suppl-cb.done{background:var(--gold);border-color:var(--gold);color:#fff}
.suppl-info{flex:1}
.suppl-name{font-size:14px;font-weight:500}
.suppl-note{font-size:11px;color:var(--gray);margin-top:2px}

/* MIND DUMP */
.md-item{display:flex;align-items:flex-start;gap:10px;padding:11px;background:var(--cream);border-radius:var(--rs);margin-bottom:8px}
.md-item.done{opacity:.5}
.md-text{flex:1;font-size:14px;line-height:1.5}
.md-text.done{text-decoration:line-through;color:var(--gray)}
.md-prio{font-size:10px;font-weight:600;padding:2px 7px;border-radius:99px;white-space:nowrap}
.p-hi{background:var(--red-l);color:var(--red)}
.p-md{background:var(--warn);color:var(--warn-fg)}
.p-lo{background:var(--green-l);color:var(--green)}
.md-btn{width:28px;height:28px;border-radius:6px;border:none;background:var(--gray-l);color:var(--gray);cursor:pointer;font-size:13px;display:flex;align-items:center;justify-content:center}
.prio-row{display:flex;gap:7px;margin-top:6px}
.prio-btn{flex:1;padding:8px;border-radius:8px;border:1.5px solid var(--gray-l);background:var(--white);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif}
.prio-btn.sel-hi{background:var(--red-l);border-color:var(--red);color:var(--red)}
.prio-btn.sel-md{background:var(--warn);border-color:var(--warn-fg);color:var(--warn-fg)}
.prio-btn.sel-lo{background:var(--green-l);border-color:var(--green);color:var(--green)}

/* LOG */
.log-item{display:flex;align-items:center;gap:12px;padding:12px;background:var(--cream);border-radius:var(--rs);margin-bottom:8px}
.log-info{flex:1}
.log-title-txt{font-size:14px;font-weight:500}
.log-meta{font-size:12px;color:var(--gray);margin-top:2px}
.log-del{width:28px;height:28px;border-radius:6px;border:none;background:var(--gray-l);color:var(--gray);cursor:pointer;font-size:13px;flex-shrink:0}
.type-tabs{display:flex;gap:6px;margin-bottom:14px;flex-wrap:wrap}
.type-tab{padding:7px 14px;border-radius:99px;border:1.5px solid var(--gray-l);background:var(--white);font-size:13px;font-weight:500;cursor:pointer;font-family:'DM Sans',sans-serif;transition:all .2s}
.type-tab.act{background:var(--navy);border-color:var(--navy);color:#fff}

/* KPI */
.kpi-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.kpi-card{background:var(--cream);border-radius:var(--rs);padding:13px;border:1px solid rgba(27,42,74,.08)}
.kpi-val{font-family:'Playfair Display',serif;font-size:24px;font-weight:700}
.kpi-lbl{font-size:12px;color:var(--gray);margin-top:3px}
.kpi-tgt{font-size:11px;color:var(--gold);font-weight:600;margin-top:2px}

/* MISC */
.celebrate{background:linear-gradient(135deg,var(--navy),var(--navy2));border-radius:var(--r);padding:20px;text-align:center;color:#fff;margin-bottom:14px}
.cel-icon{font-size:36px;margin-bottom:7px}
.cel-title{font-family:'Playfair Display',serif;font-size:18px;color:var(--gold);font-weight:700;margin-bottom:3px}
.cel-txt{font-size:13px;opacity:.75}
.z-hero{background:linear-gradient(135deg,var(--navy),var(--navy2));border-radius:var(--r);padding:22px 18px;margin-bottom:14px;display:flex;align-items:center;gap:18px}
.z-num{font-family:'Playfair Display',serif;font-size:60px;font-weight:700;color:var(--gold);line-height:1}
.z-info{flex:1}
.z-lbl{color:#fff;font-size:16px;font-weight:600}
.z-sub{color:rgba(255,255,255,.5);font-size:12px;margin-top:4px}
.z-rec{color:var(--gold-l);font-size:13px;margin-top:8px;font-weight:500}
.toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%) translateY(20px);background:var(--navy);color:#fff;padding:10px 20px;border-radius:99px;font-size:14px;font-weight:500;box-shadow:0 8px 32px rgba(27,42,74,.2);opacity:0;transition:all .3s;z-index:300;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.spin{width:28px;height:28px;border:3px solid var(--gray-l);border-top-color:var(--gold);border-radius:50%;animation:sp .8s linear infinite}
@keyframes sp{to{transform:rotate(360deg)}}
.loading{display:flex;flex-direction:column;align-items:center;gap:10px;padding:32px;color:var(--gray);font-size:13px}
.empty{text-align:center;padding:32px 16px;color:var(--gray);font-size:14px}
.empty-icon{font-size:32px;margin-bottom:8px}
.wbox{background:var(--warn);border-left:4px solid var(--gold);border-radius:var(--rs);padding:10px 13px;margin-bottom:13px;font-size:13px;color:var(--warn-fg)}
.ifield{width:100%;padding:11px;border:1.5px solid var(--gray-l);border-radius:var(--rs);font-family:'DM Sans',sans-serif;font-size:14px;color:var(--navy);outline:none;background:var(--cream)}
.ifield:focus{border-color:var(--gold)}
textarea.ifield{resize:vertical}

/* MODAL */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.5);z-index:200;display:flex;align-items:flex-end;justify-content:center}
.modal{background:var(--white);border-radius:var(--r) var(--r) 0 0;padding:22px;width:100%;max-width:600px;max-height:90vh;overflow-y:auto}
.modal-title{font-family:'Playfair Display',serif;font-size:18px;font-weight:700;margin-bottom:14px}
.emoji-grid{display:flex;flex-wrap:wrap;gap:7px;margin:8px 0}
.eg-btn{width:38px;height:38px;border-radius:8px;border:1.5px solid var(--gray-l);background:var(--white);font-size:19px;cursor:pointer}
.eg-btn.act{border-color:var(--gold);background:var(--gold-l)}
.rating-row{display:flex;gap:8px;margin-top:6px}
.rating-btn{width:36px;height:36px;border-radius:50%;border:2px solid var(--gray-l);background:var(--white);font-size:13px;font-weight:600;cursor:pointer;font-family:'DM Sans',sans-serif;color:var(--gray)}
.rating-btn.act{background:var(--gold);border-color:var(--gold);color:var(--navy)}
.ci-edit-item{display:flex;align-items:center;gap:10px;padding:10px;background:var(--cream);border-radius:var(--rs);margin-bottom:6px}
.ci-edit-item input{flex:1;padding:8px 10px;border:1.5px solid var(--gray-l);border-radius:8px;font-family:'DM Sans',sans-serif;font-size:13px;outline:none;background:var(--white)}
.ci-edit-item input:focus{border-color:var(--gold)}
.del-btn{width:28px;height:28px;border-radius:6px;border:none;background:var(--red-l);color:var(--red);cursor:pointer;font-size:14px;flex-shrink:0}

/* SAÄLIK / OPT / VISION */
.health-entry{padding:11px 0;border-bottom:1px solid var(--gray-l)}
.health-entry:last-child{border-bottom:none}
.opt-entry{padding:10px 0;border-bottom:1px solid var(--gray-l)}
.opt-entry:last-child{border-bottom:none}
.vb-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:14px}
.vb-img{position:relative;border-radius:12px;overflow:hidden;aspect-ratio:1;background:var(--gray-l)}
.vb-img img{width:100%;height:100%;object-fit:cover}
.vb-note{position:relative;border-radius:12px;padding:14px;aspect-ratio:1;display:flex;align-items:center;justify-content:center}
.vb-del{position:absolute;top:6px;right:6px;width:24px;height:24px;border-radius:50%;border:none;background:rgba(0,0,0,.4);color:#fff;cursor:pointer;font-size:11px}
.color-row{display:flex;gap:8px;margin-top:6px}
.color-swatch{width:32px;height:32px;border-radius:8px;cursor:pointer;border:2px solid transparent}
.color-swatch.act{border-color:var(--gold)}
</style>
</head>
<body>

<div class="hdr">
  <div class="hdr-r1">
    <div class="hdr-title">Lock-In 2025</div>
    <div class="hdr-streak" id="hdr-streak">ğŸ”¥ 0 gÃ¼n</div>
  </div>
  <div class="hdr-r2">
    <div class="hdr-datetime">
      <div class="hdr-date-txt" id="hdr-date">YÃ¼kleniyor...</div>
      <div class="hdr-clock-txt" id="hdr-clock">--:--:--</div>
    </div>
    <div class="hdr-right">
      <div class="hdr-days-box">
        <div class="hdr-days-num" id="hdr-days">--</div>
        <div class="hdr-days-lbl">gÃ¼n kaldÄ±</div>
      </div>
      <div class="hdr-prog-box">
        <div class="hdr-prog-pct" id="hdr-prog-pct">%0</div>
        <div class="hdr-prog-bar"><div class="hdr-prog-fill" id="hdr-prog-fill"></div></div>
      </div>
    </div>
  </div>
</div>

<nav class="nav" id="main-nav">
  <button class="nb act" onclick="showTab('bugun')">â˜€ï¸ BugÃ¼n</button>
  <button class="nb" onclick="showTab('supplement')">ğŸ’Š Supplement</button>
  <button class="nb" onclick="showTab('minddump')">ğŸ§  Mind Dump</button>
  <button class="nb" onclick="showTab('habits')">âœ… Habits</button>
  <button class="nb" onclick="showTab('zincir')">ğŸ”— Zincir</button>
  <button class="nb" onclick="showTab('wbs')">ğŸ“‹ WBS</button>
  <button class="nb" onclick="showTab('log')">ğŸ“š Log</button>
  <button class="nb" onclick="showTab('saglik')">ğŸ SaÄŸlÄ±k</button>
  <button class="nb" onclick="showTab('optimaized')">âš¡ OptimAIzed</button>
  <button class="nb" onclick="showTab('visionboard')">ğŸŒŸ Vision</button>
  <button class="nb" onclick="showTab('kpi')">ğŸ“Š KPI</button>
  <button class="nb" onclick="showTab('ayarlar')">âš™ï¸ Ayarlar</button>
</nav>

<div class="main">

<!-- BUGÃœN -->
<div id="tab-bugun">
  <div id="cel-morning" class="celebrate" style="display:none">
    <div class="cel-icon">â˜€ï¸</div>
    <div class="cel-title">Sabah check-in tamam!</div>
    <div class="cel-txt">Harika bir gÃ¼n olsun.</div>
    <div id="cel-top3-wrap" style="display:none;margin-top:10px;text-align:left;background:rgba(255,255,255,.1);border-radius:8px;padding:10px">
      <div style="font-size:11px;font-weight:600;color:var(--gold);margin-bottom:4px">ğŸ¯ BUGÃœNÃœN TOP 3</div>
      <div id="cel-top3" style="font-size:13px;color:#fff;white-space:pre-wrap;line-height:1.6"></div>
    </div>
  </div>

  <div class="card" id="card-morning">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="card-title" style="margin-bottom:0">â˜€ï¸ Sabah Check-In</div>
      <button class="btn btn-ghost btn-sm" onclick="openCheckinEdit('morning')">âœï¸ DÃ¼zenle</button>
    </div>
    <div class="slbl" style="margin-top:0">Enerji Seviyesi</div>
    <div class="energy-row" id="energy-btns"></div>
    <div class="slbl">Rutin</div>
    <div id="morning-list"></div>
    <div class="slbl">GÃ¼nÃ¼n TOP 3 Ã–nceliÄŸi</div>
    <textarea class="ifield" id="top3-input" rows="3" placeholder="1. &#10;2. &#10;3. "></textarea>
    <div style="margin-top:14px">
      <button class="btn btn-gold" onclick="saveMorning()">Sabah Check-In Kaydet</button>
    </div>
  </div>

  <div class="card">
    <div class="card-title">ğŸ“Œ BugÃ¼nÃ¼n GÃ¶revleri</div>
    <div id="today-tasks"><div class="loading"><div class="spin"></div><span>YÃ¼kleniyor...</span></div></div>
    <div style="margin-top:8px">
      <button class="btn btn-ghost btn-sm" onclick="refreshTasks()">ğŸ”„ Yenile</button>
    </div>
  </div>

  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:14px">
      <div class="card-title" style="margin-bottom:0">ğŸŒ™ AkÅŸam Check-In</div>
      <button class="btn btn-ghost btn-sm" onclick="openCheckinEdit('evening')">âœï¸ DÃ¼zenle</button>
    </div>
    <div class="slbl" style="margin-top:0">Ã–z BakÄ±m</div>
    <div id="evening-list"></div>
    <div style="margin-top:12px">
      <div class="slbl">BugÃ¼nÃ¼n En Ä°yi Åeyi</div>
      <textarea class="ifield" id="win-input" rows="2" placeholder="BugÃ¼n iyi giden 1 ÅŸey..."></textarea>
    </div>
    <div style="margin-top:12px">
      <div class="slbl">GÃ¼ne Puan Ver (0-10)</div>
      <div class="energy-row" id="day-score-btns"></div>
    </div>
    <div style="margin-top:14px">
      <button class="btn btn-navy" onclick="saveEvening()">AkÅŸam Check-In Kaydet</button>
    </div>
  </div>
</div>

<!-- SUPPLEMENT -->
<div id="tab-supplement" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ’Š BugÃ¼nÃ¼n Supplementleri</div>
    <div id="suppl-day-lbl" style="font-size:12px;color:var(--gray);margin-bottom:10px"></div>
    <div class="wbox">âš ï¸ YaÄŸlÄ± kapsÃ¼lleri (Omega-3, D3+K2) asla aÃ§ karna alma.</div>
    <div id="suppl-list"></div>
    <div id="suppl-done-msg" style="display:none;background:var(--green-l);border-radius:var(--rs);padding:12px;text-align:center;font-size:14px;font-weight:600;color:var(--green);margin-top:12px">ğŸ‰ TÃ¼m supplementler alÄ±ndÄ±!</div>
  </div>
</div>

<!-- MIND DUMP -->
<div id="tab-minddump" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ§  Mind Dump</div>
    <textarea class="ifield" id="md-input" rows="3" placeholder="Ne aklÄ±nda takÄ±lÄ±yor?"></textarea>
    <div class="slbl">Ã–ncelik</div>
    <div class="prio-row">
      <button class="prio-btn" id="pb-hi" onclick="setPrio('high')">ğŸ”´ YÃ¼ksek</button>
      <button class="prio-btn sel-md" id="pb-md" onclick="setPrio('med')">ğŸŸ¡ Orta</button>
      <button class="prio-btn" id="pb-lo" onclick="setPrio('low')">ğŸŸ¢ DÃ¼ÅŸÃ¼k</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button class="btn btn-gold" style="flex:1" onclick="addMD()">Ekle</button>
      <button class="btn btn-ghost btn-sm" onclick="addMDAsTask()">ğŸ² Task Yap</button>
    </div>
  </div>
  <div class="card">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
      <div class="card-title" style="margin-bottom:0">Liste</div>
      <div style="display:flex;gap:5px">
        <button class="btn btn-navy btn-sm" id="mdf-all" onclick="setMDFilter('all')">Hepsi</button>
        <button class="btn btn-ghost btn-sm" id="mdf-open" onclick="setMDFilter('open')">AÃ§Ä±k</button>
        <button class="btn btn-ghost btn-sm" id="mdf-done" onclick="setMDFilter('done')">Bitti</button>
      </div>
    </div>
    <div id="md-list"><div class="loading"><div class="spin"></div></div></div>
  </div>
</div>

<!-- HABITS -->
<div id="tab-habits" style="display:none">
  <div class="card">
    <div class="card-title">âœ… BugÃ¼nÃ¼n AlÄ±ÅŸkanlÄ±klarÄ±</div>
    <div id="habits-daily"></div>
  </div>
</div>

<!-- ZÄ°NCÄ°R -->
<div id="tab-zincir" style="display:none">
  <div class="z-hero">
    <div class="z-num" id="z-num">0</div>
    <div class="z-info">
      <div class="z-lbl">ğŸ”¥ Ortalama Streak</div>
      <div class="z-sub">TÃ¼m alÄ±ÅŸkanlÄ±klarÄ±n ortalamasÄ±</div>
      <div class="z-rec" id="z-rec">En uzun: 0 gÃ¼n</div>
    </div>
  </div>
  <div id="zincir-list"><div class="loading"><div class="spin"></div></div></div>
  <button class="btn btn-gold" onclick="openAddHabit()" style="margin-top:4px">+ Yeni AlÄ±ÅŸkanlÄ±k</button>
</div>

<!-- WBS -->
<div id="tab-wbs" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ“‹ WBS â€” Genel Ä°lerleme</div>
    <div id="wbs-overall"></div>
  </div>
  <div id="wbs-list"><div class="loading"><div class="spin"></div></div></div>
</div>

<!-- LOG -->
<div id="tab-log" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ“š Ä°Ã§erik Logu</div>
    <div class="type-tabs">
      <button class="type-tab act" id="lt-all" onclick="setLogFilter('all',this)">Hepsi</button>
      <button class="type-tab" onclick="setLogFilter('book',this)">ğŸ“– Kitap</button>
      <button class="type-tab" onclick="setLogFilter('article',this)">ğŸ“° Makale</button>
      <button class="type-tab" onclick="setLogFilter('video',this)">ğŸ¬ Video</button>
      <button class="type-tab" onclick="setLogFilter('podcast',this)">ğŸ™ï¸ Podcast</button>
      <button class="type-tab" onclick="setLogFilter('course',this)">ğŸ“ Kurs</button>
    </div>
    <button class="btn btn-gold" onclick="openAddLog()" style="margin-bottom:14px">+ Ekle</button>
    <div id="log-list"><div class="loading"><div class="spin"></div></div></div>
  </div>
</div>

<!-- SAÄLIK -->
<div id="tab-saglik" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ GÃ¼nlÃ¼k SaÄŸlÄ±k Logu</div>
    <div class="slbl" style="margin-top:0">Tarih</div>
    <input type="date" class="ifield" id="saglik-date">
    <div class="slbl">ğŸ˜´ Uyku</div>
    <div style="display:flex;gap:8px;align-items:center">
      <input type="number" class="ifield" id="saglik-sleep-h" placeholder="Saat" min="0" max="24" style="width:90px">
      <input type="number" class="ifield" id="saglik-sleep-q" placeholder="Kalite 1-5" min="1" max="5" style="width:110px">
    </div>
    <div class="slbl">ğŸ‹ï¸ Egzersiz</div>
    <input class="ifield" id="saglik-exercise" placeholder="Ã¶rn: 30 dk yÃ¼rÃ¼yÃ¼ÅŸ">
    <div class="slbl">ğŸ¥— Yemekler</div>
    <textarea class="ifield" id="saglik-food" rows="2" placeholder="KahvaltÄ±, Ã¶ÄŸle, akÅŸam..."></textarea>
    <div class="slbl">ğŸ’§ Su (litre)</div>
    <input type="number" class="ifield" id="saglik-water" placeholder="2.5" step="0.5">
    <div class="slbl">ğŸ“ Not</div>
    <textarea class="ifield" id="saglik-note" rows="2" placeholder="NasÄ±l hissettin?"></textarea>
    <div style="margin-top:14px"><button class="btn btn-gold" onclick="saveSaglik()">Kaydet</button></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“‹ GeÃ§miÅŸ</div>
    <div id="saglik-history"><div class="loading"><div class="spin"></div></div></div>
  </div>
</div>

<!-- OPTÄ°MAÄ°ZED -->
<div id="tab-optimaized" style="display:none">
  <div class="z-hero" style="margin-bottom:14px">
    <div style="flex:1">
      <div style="font-family:'Playfair Display',serif;color:var(--gold);font-size:22px;font-weight:700">OptimAIzed Life</div>
      <div style="color:rgba(255,255,255,.6);font-size:13px;margin-top:4px">Ä°Ã§erik & BÃ¼yÃ¼me Metrikleri</div>
    </div>
    <div style="font-size:36px">âš¡</div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“Š Bu Hafta</div>
    <div id="opt-view"><div class="loading"><div class="spin"></div></div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“ GÃ¼ncelle</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">HazÄ±rlanan iÃ§erik</div><input type="number" id="opt-prepared" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">PaylaÅŸÄ±lan iÃ§erik</div><input type="number" id="opt-published" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">Reels</div><input type="number" id="opt-reels" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">Stories</div><input type="number" id="opt-stories" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">TakipÃ§i</div><input type="number" id="opt-followers" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">TakipÃ§i artÄ±ÅŸÄ±</div><input type="number" id="opt-fgain" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">Ä°zlenme</div><input type="number" id="opt-views" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">BeÄŸeni</div><input type="number" id="opt-likes" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">Kaydetme</div><input type="number" id="opt-saves" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">Reach</div><input type="number" id="opt-reach" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">SatÄ±ÅŸ</div><input type="number" id="opt-sales" class="ifield" placeholder="0"></div>
      <div><div style="font-size:12px;color:var(--gray);margin-bottom:3px">Gelir (â‚¬)</div><input type="number" id="opt-revenue" class="ifield" placeholder="0" step="0.01"></div>
    </div>
    <button class="btn btn-gold" style="margin-top:14px" onclick="saveOpt()">Kaydet</button>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“ˆ GeÃ§miÅŸ</div>
    <div id="opt-history"><div class="loading"><div class="spin"></div></div></div>
  </div>
</div>

<!-- VÄ°SÄ°ON BOARD -->
<div id="tab-visionboard" style="display:none">
  <div class="card">
    <div class="card-title">ğŸŒŸ Vision Board</div>
    <div style="display:flex;gap:8px">
      <button class="btn btn-gold" style="flex:1" onclick="document.getElementById('vb-file').click()">ğŸ“¸ GÃ¶rsel Ekle</button>
      <button class="btn btn-ghost btn-sm" onclick="openVBNote()">âœï¸ Not</button>
    </div>
    <input type="file" id="vb-file" accept="image/*" style="display:none" onchange="uploadVBImg(event)">
  </div>
  <div class="vb-grid" id="vb-grid"></div>
</div>

<!-- KPI -->
<div id="tab-kpi" style="display:none">
  <div class="card">
    <div class="card-title">ğŸ“Š HaftalÄ±k KPI</div>
    <div id="kpi-view"><div class="loading"><div class="spin"></div></div></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“ GÃ¼ncelle</div>
    <div id="kpi-form"></div>
    <button class="btn btn-navy" style="margin-top:12px" onclick="saveKPI()">Kaydet</button>
  </div>
</div>

<!-- AYARLAR -->
<div id="tab-ayarlar" style="display:none">
  <div class="card">
    <div class="card-title">â³ Geri SayÄ±m Tarihi</div>
    <div style="margin-bottom:10px">
      <div style="font-size:12px;color:var(--gray);margin-bottom:3px">Mevcut hedef</div>
      <div style="font-size:18px;font-weight:700;color:var(--gold)" id="cd-current">1 Nisan 2026</div>
      <div style="font-size:13px;color:var(--gray);margin-top:2px" id="cd-left"></div>
    </div>
    <input type="date" class="ifield" id="cd-new-date">
    <div style="margin-top:10px"><button class="btn btn-navy btn-sm" onclick="saveDeadline()" style="width:100%">Tarihi GÃ¼ncelle</button></div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“± Telegram</div>
    <input class="ifield" id="tg-token" placeholder="Bot Token">
    <input class="ifield" id="tg-chatid" placeholder="Chat ID" style="margin-top:8px">
    <div style="display:flex;gap:8px;margin-top:10px">
      <button class="btn btn-navy btn-sm" onclick="saveTG()" style="flex:1">Kaydet</button>
      <button class="btn btn-ghost btn-sm" onclick="testTG()" style="flex:1">ğŸ“¨ Test</button>
    </div>
  </div>
  <div class="card">
    <div class="card-title">ğŸ“… Program</div>
    <div style="font-size:13px;color:var(--gray);line-height:2.2">
      ğŸŸ¢ <b>Faz 1:</b> 20 Åub â€“ 2 Mar<br>
      ğŸŸ¡ <b>Faz 2:</b> 3 â€“ 17 Mar<br>
      âœˆï¸ <b>TÃ¼rkiye:</b> 18 â€“ 24 Mar<br>
      ğŸ”µ <b>Faz 3:</b> 25 â€“ 31 Mar
    </div>
  </div>
</div>

</div><!-- /main -->

<!-- HABIT MODAL -->
<div class="modal-bg" id="habit-modal" style="display:none" onclick="if(event.target===this)closeModal('habit-modal')">
  <div class="modal">
    <div class="modal-title" id="hm-title">Yeni AlÄ±ÅŸkanlÄ±k</div>
    <div class="slbl" style="margin-top:0">Ä°kon</div>
    <div class="emoji-grid" id="emoji-grid"></div>
    <div class="slbl">Ad</div>
    <input class="ifield" id="h-name" placeholder="Ã¶rn: Meditasyon">
    <div class="slbl">AÃ§Ä±klama</div>
    <input class="ifield" id="h-desc" placeholder="Ã¶rn: 10 dk sabah meditasyonu" style="margin-top:6px">
    <div class="slbl">Numerik Hedef (opsiyonel)</div>
    <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px;margin-top:6px">
      <div>
        <div style="font-size:11px;color:var(--gray);margin-bottom:3px">Hedef</div>
        <input class="ifield" id="h-target" type="number" placeholder="2.5" step="0.5" min="0">
      </div>
      <div>
        <div style="font-size:11px;color:var(--gray);margin-bottom:3px">Birim</div>
        <input class="ifield" id="h-unit" placeholder="litre">
      </div>
      <div>
        <div style="font-size:11px;color:var(--gray);margin-bottom:3px">AdÄ±m</div>
        <input class="ifield" id="h-step" type="number" placeholder="0.5" step="0.1" min="0.1">
      </div>
    </div>
    <div style="font-size:11px;color:var(--gray);margin-top:4px">BoÅŸ bÄ±rakÄ±rsan normal tick olur.</div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-gold" id="h-save-btn" onclick="saveHabit()" style="flex:1">Kaydet</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('habit-modal')" style="flex:0.4">Ä°ptal</button>
    </div>
    <button class="btn btn-red btn-sm" id="h-del-btn" style="display:none;width:100%;margin-top:8px" onclick="deleteHabit()">Sil</button>
  </div>
</div>

<!-- CHECK-IN EDIT MODAL -->
<div class="modal-bg" id="ci-modal" style="display:none" onclick="if(event.target===this)closeModal('ci-modal')">
  <div class="modal">
    <div class="modal-title" id="ci-modal-title">Rutin DÃ¼zenle</div>
    <div id="ci-edit-list"></div>
    <button class="btn btn-ghost" onclick="addCIItem()" style="margin-top:8px">+ Madde Ekle</button>
    <div style="display:flex;gap:8px;margin-top:14px">
      <button class="btn btn-gold" onclick="saveCIItems()" style="flex:1">Kaydet</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('ci-modal')" style="flex:0.4">Ä°ptal</button>
    </div>
  </div>
</div>

<!-- LOG MODAL -->
<div class="modal-bg" id="log-modal" style="display:none" onclick="if(event.target===this)closeModal('log-modal')">
  <div class="modal">
    <div class="modal-title">Ä°Ã§erik Ekle</div>
    <div class="slbl" style="margin-top:0">TÃ¼r</div>
    <div class="type-tabs" id="log-type-tabs">
      <button class="type-tab act" onclick="setNewLogType('book',this)">ğŸ“– Kitap</button>
      <button class="type-tab" onclick="setNewLogType('article',this)">ğŸ“° Makale</button>
      <button class="type-tab" onclick="setNewLogType('video',this)">ğŸ¬ Video</button>
      <button class="type-tab" onclick="setNewLogType('podcast',this)">ğŸ™ï¸ Podcast</button>
      <button class="type-tab" onclick="setNewLogType('course',this)">ğŸ“ Kurs</button>
    </div>
    <div class="slbl">BaÅŸlÄ±k</div>
    <input class="ifield" id="log-title-in" placeholder="Ã¶rn: Atomic Habits">
    <div class="slbl">Yazar / Kaynak</div>
    <input class="ifield" id="log-author-in" placeholder="Ã¶rn: James Clear" style="margin-top:6px">
    <div class="slbl">Puan (1-5)</div>
    <div class="rating-row" id="log-rating-row"></div>
    <div class="slbl">Not</div>
    <textarea class="ifield" id="log-note-in" rows="2" placeholder="En Ã¶nemli Ã§Ä±karÄ±m..." style="margin-top:6px"></textarea>
    <div class="slbl">Durum</div>
    <div class="type-tabs" id="log-status-tabs">
      <button class="type-tab act" onclick="setLogStatus('reading',this)">ğŸ“– Devam ediyor</button>
      <button class="type-tab" onclick="setLogStatus('done',this)">âœ… TamamlandÄ±</button>
      <button class="type-tab" onclick="setLogStatus('want',this)">ğŸ”– Listede</button>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-gold" onclick="saveLog()" style="flex:1">Kaydet</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('log-modal')" style="flex:0.4">Ä°ptal</button>
    </div>
  </div>
</div>

<!-- VISION NOTE MODAL -->
<div class="modal-bg" id="vb-modal" style="display:none" onclick="if(event.target===this)closeModal('vb-modal')">
  <div class="modal">
    <div class="modal-title">Not / Hedef Ekle</div>
    <textarea class="ifield" id="vb-note-text" rows="3" placeholder="Hedefin, motivasyon cÃ¼mlesi..."></textarea>
    <div class="slbl">Renk</div>
    <div class="color-row" id="vb-colors">
      <div class="color-swatch act" style="background:#F5EDD6" onclick="setVBColor('#F5EDD6',this)"></div>
      <div class="color-swatch" style="background:#EAF4EA" onclick="setVBColor('#EAF4EA',this)"></div>
      <div class="color-swatch" style="background:#FFF3CD" onclick="setVBColor('#FFF3CD',this)"></div>
      <div class="color-swatch" style="background:#F3F4F6" onclick="setVBColor('#F3F4F6',this)"></div>
      <div class="color-swatch" style="background:#1B2A4A" onclick="setVBColor('#1B2A4A',this)"></div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-gold" onclick="saveVBNote()" style="flex:1">Ekle</button>
      <button class="btn btn-ghost btn-sm" onclick="closeModal('vb-modal')" style="flex:0.4">Ä°ptal</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
const SURL='https://ucwgkduvpnklfggleupb.supabase.co';
const SKEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVjd2drZHV2cG5rbGZnZ2xldXBiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE2MDE1NzcsImV4cCI6MjA4NzE3NzU3N30.AKBjKoYp2xie6qd19crJVMIJDFzmXPTqU2BTtFHnypw';
const sb = supabase.createClient(SURL, SKEY);

const TABS = ['bugun','supplement','minddump','habits','zincir','wbs','log','saglik','optimaized','visionboard','kpi','ayarlar'];
const EMOJIS = ['ğŸ’§','ğŸ’Š','ğŸ“–','ğŸ““','âœ¨','ğŸš¿','ğŸ¦·','ğŸƒ','ğŸ§˜','ğŸ¥—','ğŸŒ¿','ğŸ’ª','â˜•','ğŸ¯','ğŸ“š','âœï¸','ğŸ¸','ğŸ–¥ï¸','ğŸ§¹','ğŸ’¤','ğŸ§´','ğŸ’†','ğŸ‹ï¸','ğŸ¨'];
const DN = ['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
const MN = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
const DS = ['Pz','Pt','Sa','Ã‡a','Pe','Cu','Ct'];
const SUPPL = {
  0:[{n:'D3+K2, Omega-3, B-Complex',t:'Sabah'},{n:'Creatine+Kolajen',t:'GÃ¼n iÃ§i'},{n:'Mg+Zinc',t:'AkÅŸam'}],
  1:[{n:'D3+K2, Omega-3, B-Complex, Resveratrol',t:'Sabah (yemekle)',note:'YaÄŸlÄ± kapsÃ¼ller'},{n:'Kolajen+C',t:'Ara Ã¶ÄŸÃ¼n'},{n:'Creatine 3g',t:'Ã–ÄŸlen'},{n:'Mg+Zinc',t:'AkÅŸam'}],
  2:[{n:'D3+K2, Omega-3, B-Complex, Resveratrol',t:'Sabah'},{n:'Kolajen+C',t:'Ara Ã¶ÄŸÃ¼n'},{n:'Creatine 3g',t:'Ã–ÄŸlen'},{n:'Mg+Zinc',t:'AkÅŸam'}],
  3:[{n:'D3+K2, Omega-3, B-Complex, Resveratrol',t:'Sabah'},{n:'Kolajen+C',t:'Ara Ã¶ÄŸÃ¼n'},{n:'Creatine 3g',t:'Ã–ÄŸlen'},{n:'Mg+Zinc',t:'AkÅŸam'}],
  4:[{n:'D3+K2, Omega-3, B-Complex',t:'Sabah'},{n:'Enjeksiyon+Mg',t:'AkÅŸam',note:'Zinc atlanabilir'}],
  5:[{n:'D3+K2, Omega-3, B-Complex',t:'Sabah',note:'En hassas gÃ¼n'},{n:'Creatine (az)',t:'Ã–ÄŸlen'},{n:'Mg',t:'AkÅŸam'}],
  6:[{n:'D3+K2, Omega-3, B-Complex',t:'Sabah'},{n:'Kolajen+Creatine',t:'GÃ¼n iÃ§i'},{n:'Mg+Zinc',t:'AkÅŸam'}]
};
const LOG_ICONS = {book:'ğŸ“–',article:'ğŸ“°',video:'ğŸ¬',podcast:'ğŸ™ï¸',course:'ğŸ“'};
const STATUS_LBL = {reading:'ğŸ“– Devam ediyor',done:'âœ… TamamlandÄ±',want:'ğŸ”– Listede'};
const DEADLINE_KEY = 'lockin_deadline';

// STATE
let TODAY = getToday();
let energy = 0;
let dayScore = 0;
let morningDone = false;
let eveningDone = false;
let editHabitId = null;
let selEmoji = EMOJIS[0];
let mdPrio = 'med';
let mdFilter = 'all';
let newLogType = 'book';
let logStatus = 'reading';
let logRating = 0;
let vbColor = '#F5EDD6';
let editCIType = null;

const DEFAULT_MORNING = [
  {key:'water', label:'ğŸ’§ 1 bardak su iÃ§tim'},
  {key:'affirmations', label:'âœ¨ AffirmationlarÄ±mÄ± okudum'},
  {key:'journaling', label:'ğŸ““ Journaling yaptÄ±m'},
  {key:'reading', label:'ğŸ“– Hollandaca okuma (15 dk)'},
  {key:'supplement', label:'ğŸ’Š Sabah supplementlerimi aldÄ±m'},
];
const DEFAULT_EVENING = [
  {key:'teeth', label:'ğŸ¦· DiÅŸ fÄ±rÃ§aladÄ±m'},
  {key:'shower', label:'ğŸš¿ DuÅŸ aldÄ±m'},
];

let morningItems = JSON.parse(localStorage.getItem('ci_morning') || JSON.stringify(DEFAULT_MORNING));
let eveningItems = JSON.parse(localStorage.getItem('ci_evening') || JSON.stringify(DEFAULT_EVENING));
let morningChecks = {};
let eveningChecks = {};

// UTILS
function getToday() {
  const d = new Date();
  return d.getFullYear() + '-' + String(d.getMonth()+1).padStart(2,'0') + '-' + String(d.getDate()).padStart(2,'0');
}
function getDeadline() {
  const s = localStorage.getItem(DEADLINE_KEY);
  return s ? new Date(s) : new Date('2026-04-01T00:00:00');
}
function getMonday() {
  const d = new Date();
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  d.setDate(diff);
  return d.toISOString().split('T')[0];
}
function toast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), 2500);
}
function closeModal(id) {
  document.getElementById(id).style.display = 'none';
}
function numVal(id) {
  return parseFloat(document.getElementById(id).value) || 0;
}

// HEADER
function initHeader() {
  updateDateDisplay();
  startClock();
  updateCountdown();
  setInterval(updateCountdown, 60000);
}
function updateDateDisplay() {
  const n = new Date();
  document.getElementById('hdr-date').textContent =
    DN[n.getDay()] + ', ' + n.getDate() + ' ' + MN[n.getMonth()] + ' ' + n.getFullYear();
}
function startClock() {
  function tick() {
    const n = new Date();
    document.getElementById('hdr-clock').textContent =
      String(n.getHours()).padStart(2,'0') + ':' +
      String(n.getMinutes()).padStart(2,'0') + ':' +
      String(n.getSeconds()).padStart(2,'0');
    TODAY = getToday();
  }
  tick();
  setInterval(tick, 1000);
}
function updateCountdown() {
  const diff = Math.ceil((getDeadline() - new Date()) / (1000*60*60*24));
  document.getElementById('hdr-days').textContent = diff > 0 ? diff : '0';
}
async function loadHeaderProgress() {
  try {
    const {data:cats} = await sb.from('wbs_categories').select('wbs_tasks(wbs_microtasks(is_completed))');
    if (!cats) return;
    let total = 0, done = 0;
    cats.forEach(c => (c.wbs_tasks||[]).forEach(t => (t.wbs_microtasks||[]).forEach(m => {
      total++; if (m.is_completed) done++;
    })));
    const pct = total ? Math.round(done/total*100) : 0;
    document.getElementById('hdr-prog-fill').style.width = pct + '%';
    document.getElementById('hdr-prog-pct').textContent = '%' + pct;
  } catch(e) {}
}

// TAB
function showTab(name) {
  TABS.forEach(t => {
    const el = document.getElementById('tab-' + t);
    if (el) el.style.display = t === name ? 'block' : 'none';
  });
  document.querySelectorAll('.nb').forEach((b, i) => b.classList.toggle('act', TABS[i] === name));
  if (name === 'zincir') loadZincir();
  if (name === 'habits') loadHabitsDaily();
  if (name === 'wbs') loadWBS();
  if (name === 'supplement') renderSupplements();
  if (name === 'kpi') loadKPI();
  if (name === 'ayarlar') loadAyarlar();
  if (name === 'minddump') loadMindDump();
  if (name === 'log') loadLog();
  if (name === 'saglik') initSaglik();
  if (name === 'optimaized') loadOpt();
  if (name === 'visionboard') loadVisionBoard();
}

// ENERGY BTNS
function renderEnergyBtns() {
  const w = document.getElementById('energy-btns');
  w.innerHTML = '';
  for (let i = 1; i <= 10; i++) {
    const b = document.createElement('button');
    b.className = 'ebtn' + (i === energy ? ' act' : '');
    b.textContent = i;
    const val = i;
    b.onclick = () => { energy = val; renderEnergyBtns(); };
    if (morningDone) b.disabled = true;
    w.appendChild(b);
  }
}
function renderDayScoreBtns() {
  const w = document.getElementById('day-score-btns');
  if (!w) return;
  w.innerHTML = '';
  for (let i = 0; i <= 10; i++) {
    const b = document.createElement('button');
    b.className = 'ebtn' + (i === dayScore ? ' act' : '');
    b.textContent = i;
    const val = i;
    b.onclick = () => { dayScore = val; renderDayScoreBtns(); };
    if (eveningDone) b.disabled = true;
    w.appendChild(b);
  }
}

// CHECK-IN LISTS
function renderMorningList() {
  const el = document.getElementById('morning-list');
  if (!el) return;
  el.innerHTML = morningItems.map((item, i) => {
    const done = morningChecks[item.key] || false;
    const ro = morningDone ? ' ro' : '';
    return '<div class="ci' + ro + '" onclick="toggleMorning(' + i + ')">'
      + '<div class="cb' + (done ? ' done' : '') + '">' + (done ? 'âœ“' : '') + '</div>'
      + '<span class="cl' + (done ? ' done' : '') + '">' + item.label + '</span>'
      + '</div>';
  }).join('');
}
function toggleMorning(i) {
  if (morningDone) return;
  const key = morningItems[i].key;
  morningChecks[key] = !morningChecks[key];
  localStorage.setItem('mc_' + TODAY, JSON.stringify(morningChecks));
  renderMorningList();
}

function renderEveningList() {
  const el = document.getElementById('evening-list');
  if (!el) return;
  el.innerHTML = eveningItems.map((item, i) => {
    const done = eveningChecks[item.key] || false;
    const ro = eveningDone ? ' ro' : '';
    return '<div class="ci' + ro + '" onclick="toggleEvening(' + i + ')">'
      + '<div class="cb' + (done ? ' done' : '') + '">' + (done ? 'âœ“' : '') + '</div>'
      + '<span class="cl' + (done ? ' done' : '') + '">' + item.label + '</span>'
      + '</div>';
  }).join('');
}
function toggleEvening(i) {
  if (eveningDone) return;
  const key = eveningItems[i].key;
  eveningChecks[key] = !eveningChecks[key];
  localStorage.setItem('ec_' + TODAY, JSON.stringify(eveningChecks));
  renderEveningList();
}

// CHECK-IN EDIT
function openCheckinEdit(type) {
  editCIType = type;
  document.getElementById('ci-modal-title').textContent = type === 'morning' ? 'Sabah Rutini DÃ¼zenle' : 'AkÅŸam Rutini DÃ¼zenle';
  renderCIEditList();
  document.getElementById('ci-modal').style.display = 'flex';
}
function renderCIEditList() {
  const items = editCIType === 'morning' ? morningItems : eveningItems;
  document.getElementById('ci-edit-list').innerHTML = items.map((item, i) =>
    '<div class="ci-edit-item" data-i="' + i + '">'
    + '<span style="font-size:16px">â˜°</span>'
    + '<input type="text" value="' + item.label.replace(/"/g,'&quot;') + '" oninput="updateCILabel(' + i + ',this.value)">'
    + '<button class="del-btn" onclick="removeCIItem(' + i + ')">âœ•</button>'
    + '</div>'
  ).join('');
}
function updateCILabel(i, val) {
  if (editCIType === 'morning') morningItems[i].label = val;
  else eveningItems[i].label = val;
}
function addCIItem() {
  const newItem = {key:'item_'+Date.now(), label:'Yeni madde'};
  if (editCIType === 'morning') morningItems.push(newItem);
  else eveningItems.push(newItem);
  renderCIEditList();
}
function removeCIItem(i) {
  if (editCIType === 'morning') morningItems.splice(i, 1);
  else eveningItems.splice(i, 1);
  renderCIEditList();
}
function saveCIItems() {
  if (editCIType === 'morning') {
    localStorage.setItem('ci_morning', JSON.stringify(morningItems));
    renderMorningList();
  } else {
    localStorage.setItem('ci_evening', JSON.stringify(eveningItems));
    renderEveningList();
  }
  closeModal('ci-modal');
  toast('Rutin gÃ¼ncellendi!');
}

// SAVE MORNING
async function saveMorning() {
  if (!energy) { toast('Enerji skorunu seÃ§!'); return; }
  const top3 = document.getElementById('top3-input').value.trim();
  try {
    await sb.from('daily_checkins').upsert({
      date: TODAY, type: 'morning', energy_score: energy,
      water_done: morningChecks['water'] || false,
      affirmations_done: morningChecks['affirmations'] || false,
      journaling_done: morningChecks['journaling'] || false,
      reading_done: morningChecks['reading'] || false,
      supplement_done: morningChecks['supplement'] || false,
      top3: top3,
    }, {onConflict: 'date,type'});
    morningDone = true;
    document.getElementById('card-morning').style.display = 'none';
    document.getElementById('cel-morning').style.display = 'block';
    if (top3) {
      document.getElementById('cel-top3').textContent = top3;
      document.getElementById('cel-top3-wrap').style.display = 'block';
    }
    renderEnergyBtns();
    toast('âœ… Sabah check-in kaydedildi!');
    await loadTodayTasks();
    await calcStreak();
    sendTG('â˜€ï¸ Sabah check-in tamam! Enerji: ' + energy + '/10');
  } catch(e) { toast('Hata: ' + e.message); }
}

// SAVE EVENING
async function saveEvening() {
  const win = document.getElementById('win-input').value.trim();
  try {
    await sb.from('daily_checkins').upsert({
      date: TODAY, type: 'evening',
      teeth_done: eveningChecks['teeth'] || false,
      shower_done: eveningChecks['shower'] || false,
      win_of_day: win,
      day_score: dayScore || null,
    }, {onConflict: 'date,type'});
    eveningDone = true;
    renderEveningList();
    renderDayScoreBtns();
    const winEl = document.getElementById('win-input');
    winEl.readOnly = true; winEl.style.opacity = '.65';
    document.querySelector('button[onclick="saveEvening()"]').disabled = true;
    document.querySelector('button[onclick="saveEvening()"]').style.opacity = '.5';
    toast('ğŸŒ™ AkÅŸam check-in kaydedildi!');
    sendTG('ğŸŒ™ AkÅŸam check-in tamam! Puan: ' + dayScore + '/10');
  } catch(e) { toast('Hata: ' + e.message); }
}

// LOAD CHECKIN
async function loadTodayCheckin() {
  const savedMC = localStorage.getItem('mc_' + TODAY);
  if (savedMC) morningChecks = JSON.parse(savedMC);
  const savedEC = localStorage.getItem('ec_' + TODAY);
  if (savedEC) eveningChecks = JSON.parse(savedEC);
  try {
    const {data} = await sb.from('daily_checkins').select('*').eq('date', TODAY);
    if (!data || !data.length) return;
    const m = data.find(d => d.type === 'morning');
    if (m) {
      morningDone = true;
      energy = m.energy_score || 0;
      document.getElementById('card-morning').style.display = 'none';
      document.getElementById('cel-morning').style.display = 'block';
      if (m.top3) {
        document.getElementById('cel-top3').textContent = m.top3;
        document.getElementById('cel-top3-wrap').style.display = 'block';
      }
    }
    const ev = data.find(d => d.type === 'evening');
    if (ev) {
      eveningDone = true;
      if (ev.win_of_day) {
        const winEl = document.getElementById('win-input');
        winEl.value = ev.win_of_day;
        winEl.readOnly = true; winEl.style.opacity = '.65';
      }
      if (ev.day_score != null) dayScore = ev.day_score;
      setTimeout(() => {
        const btn = document.querySelector('button[onclick="saveEvening()"]');
        if (btn) { btn.disabled = true; btn.style.opacity = '.5'; }
      }, 100);
    }
  } catch(e) {}
  renderMorningList();
  renderEveningList();
  renderEnergyBtns();
  renderDayScoreBtns();
}

// TASKS
async function loadTodayTasks() {
  const el = document.getElementById('today-tasks');
  el.innerHTML = '<div class="loading"><div class="spin"></div><span>YÃ¼kleniyor...</span></div>';
  try {
    const {data:existing} = await sb.from('daily_tasks')
      .select('id,status,source,microtask_id,mind_dump_id,wbs_microtasks(title,wbs_tasks(title,wbs_categories(label)))')
      .eq('date', TODAY);
    if (existing && existing.length) {
      await renderTasksWithMD(existing);
      return;
    }
    // Generate
    const count = (energy <= 4 && energy > 0) ? 1 : 2;
    const {data:mts} = await sb.from('wbs_microtasks')
      .select('id,title,wbs_tasks(title,wbs_categories(label))')
      .eq('is_completed', false)
      .limit(10);
    const inserts = [];
    if (mts && mts.length > 0) inserts.push({date:TODAY, microtask_id:mts[0].id, status:'pending', source:'wbs'});
    if (count >= 2) {
      let added = false;
      try {
        const {data:mdI} = await sb.from('mind_dump_items').select('id').eq('is_done', false).limit(5);
        if (mdI && mdI.length) {
          inserts.push({date:TODAY, mind_dump_id:mdI[Math.floor(Math.random()*mdI.length)].id, status:'pending', source:'minddump'});
          added = true;
        }
      } catch(e) {}
      if (!added && mts && mts.length > 1) inserts.push({date:TODAY, microtask_id:mts[1].id, status:'pending', source:'wbs'});
    }
    for (const ins of inserts) { try { await sb.from('daily_tasks').insert(ins); } catch(e) {} }
    const {data:newT} = await sb.from('daily_tasks')
      .select('id,status,source,microtask_id,mind_dump_id,wbs_microtasks(title,wbs_tasks(title,wbs_categories(label)))')
      .eq('date', TODAY);
    await renderTasksWithMD(newT || []);
  } catch(e) {
    el.innerHTML = '<div class="empty"><div class="empty-icon">âš ï¸</div>' + e.message + '</div>';
  }
}
async function renderTasksWithMD(tasks) {
  let mdTexts = {};
  const mdIds = tasks.filter(t => t.mind_dump_id).map(t => t.mind_dump_id);
  if (mdIds.length) {
    try {
      const {data:md} = await sb.from('mind_dump_items').select('id,text').in('id', mdIds);
      if (md) md.forEach(m => mdTexts[m.id] = m.text);
    } catch(e) {}
  }
  const el = document.getElementById('today-tasks');
  if (!tasks.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Œ</div>Ã–nce enerji skorunu gir</div>'; return; }
  el.innerHTML = tasks.map(t => {
    const done = t.status === 'done', part = t.status === 'partial', isMD = t.source === 'minddump';
    const title = isMD ? (mdTexts[t.mind_dump_id] || 'Mind Dump Task') : ((t.wbs_microtasks && t.wbs_microtasks.title) || 'â€”');
    const cat = isMD ? 'ğŸ§  Mind Dump' : ((t.wbs_microtasks && t.wbs_microtasks.wbs_tasks && t.wbs_microtasks.wbs_tasks.wbs_categories && t.wbs_microtasks.wbs_tasks.wbs_categories.label) || '');
    const mid = t.microtask_id || '', mdid = t.mind_dump_id || '';
    return '<div class="task-item' + (done ? ' done' : '') + '" data-id="' + t.id + '" data-status="' + t.status + '" data-source="' + t.source + '" data-mid="' + mid + '" data-mdid="' + mdid + '" onclick="cycleTask(this)">'
      + '<div class="task-check' + (done ? ' done' : '') + '">' + (done ? 'âœ“' : '') + '</div>'
      + '<div class="task-info"><div class="task-title">' + title + '</div><div class="task-cat">' + cat + '</div></div>'
      + '<span class="badge ' + (done ? 'b-done' : part ? 'b-part' : 'b-pend') + '">' + (done ? 'âœ“ Bitti' : part ? '~ KÄ±smen' : 'Bekliyor') + '</span>'
      + '</div>';
  }).join('');
}
async function cycleTask(el) {
  const id = el.dataset.id, status = el.dataset.status, source = el.dataset.source;
  const mid = el.dataset.mid, mdid = el.dataset.mdid;
  const next = status === 'pending' ? 'done' : status === 'done' ? 'partial' : 'pending';
  try {
    await sb.from('daily_tasks').update({status: next}).eq('id', id);
    if (next === 'done') {
      if (source === 'wbs' && mid && mid !== 'null' && mid !== '') {
        await sb.from('wbs_microtasks').update({is_completed: true, completed_at: new Date().toISOString()}).eq('id', mid);
        loadHeaderProgress();
      }
      if (source === 'minddump' && mdid && mdid !== 'null' && mdid !== '') {
        try { await sb.from('mind_dump_items').update({is_done: true}).eq('id', mdid); } catch(e) {}
      }
      toast('âœ… TamamlandÄ±!');
    }
    await loadTodayTasks();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function refreshTasks() {
  try { await sb.from('daily_tasks').delete().eq('date', TODAY); } catch(e) {}
  await loadTodayTasks();
}

// SUPPLEMENT
function renderSupplements() {
  const day = new Date().getDay();
  const items = SUPPL[day] || SUPPL[1];
  const names = ['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
  document.getElementById('suppl-day-lbl').textContent = names[day];
  const saved = JSON.parse(localStorage.getItem('suppl_' + TODAY) || '{}');
  document.getElementById('suppl-list').innerHTML = items.map((item, i) => {
    const done = saved[i] || false;
    return '<div class="suppl-item" data-i="' + i + '" onclick="toggleSuppl(' + i + ',' + items.length + ')">'
      + '<div class="suppl-cb' + (done ? ' done' : '') + '">' + (done ? 'âœ“' : '') + '</div>'
      + '<div class="suppl-info">'
      + '<div class="suppl-name">' + item.n + '</div>'
      + '<div class="suppl-note">' + item.t + (item.note ? ' Â· ' + item.note : '') + '</div>'
      + '</div></div>';
  }).join('');
  const doneCount = Object.values(saved).filter(Boolean).length;
  document.getElementById('suppl-done-msg').style.display = doneCount >= items.length ? 'block' : 'none';
}
async function toggleSuppl(i, total) {
  const saved = JSON.parse(localStorage.getItem('suppl_' + TODAY) || '{}');
  saved[i] = !saved[i];
  localStorage.setItem('suppl_' + TODAY, JSON.stringify(saved));
  const day = new Date().getDay();
  const items = SUPPL[day] || SUPPL[1];
  renderSupplements();
  const doneCount = Object.values(saved).filter(Boolean).length;
  if (doneCount >= items.length) {
    try {
      const {data:h} = await sb.from('habits').select('id').ilike('name','%supplement%').limit(1);
      if (h && h.length) await sb.from('habit_logs').upsert({habit_id:h[0].id,date:TODAY},{onConflict:'habit_id,date'});
    } catch(e) {}
    toast('ğŸ’Š TÃ¼m supplementler tamam! ğŸ‰');
  }
}

// MIND DUMP
function setPrio(p) {
  mdPrio = p;
  document.getElementById('pb-hi').className = 'prio-btn' + (p === 'high' ? ' sel-hi' : '');
  document.getElementById('pb-md').className = 'prio-btn' + (p === 'med' ? ' sel-md' : '');
  document.getElementById('pb-lo').className = 'prio-btn' + (p === 'low' ? ' sel-lo' : '');
}
async function addMD() {
  const text = document.getElementById('md-input').value.trim();
  if (!text) { toast('Bir ÅŸeyler yaz!'); return; }
  try {
    await sb.from('mind_dump_items').insert({text, priority: mdPrio, is_done: false});
    document.getElementById('md-input').value = '';
    toast('Eklendi!');
    await loadMindDump();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function addMDAsTask() {
  const text = document.getElementById('md-input').value.trim();
  if (!text) { toast('Bir ÅŸeyler yaz!'); return; }
  try {
    const {data:item} = await sb.from('mind_dump_items').insert({text, priority: mdPrio, is_done: false}).select().single();
    if (item) {
      await sb.from('daily_tasks').insert({date: TODAY, mind_dump_id: item.id, status: 'pending', source: 'minddump'});
      document.getElementById('md-input').value = '';
      toast('Task olarak eklendi!');
      await loadMindDump();
      await loadTodayTasks();
    }
  } catch(e) { toast('Hata: ' + e.message); }
}
function setMDFilter(f) {
  mdFilter = f;
  ['all','open','done'].forEach(x => {
    document.getElementById('mdf-' + x).className = 'btn btn-' + (x === f ? 'navy' : 'ghost') + ' btn-sm';
  });
  loadMindDump();
}
async function loadMindDump() {
  try {
    const {data} = await sb.from('mind_dump_items').select('*').order('created_at', {ascending: false});
    let items = data || [];
    if (mdFilter === 'open') items = items.filter(d => !d.is_done);
    if (mdFilter === 'done') items = items.filter(d => d.is_done);
    const el = document.getElementById('md-list');
    if (!items.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ§ </div>HenÃ¼z hiÃ§bir ÅŸey yok.</div>'; return; }
    const pM = {high:'ğŸ”´ YÃ¼ksek', med:'ğŸŸ¡ Orta', low:'ğŸŸ¢ DÃ¼ÅŸÃ¼k'};
    const pC = {high:'md-prio p-hi', med:'md-prio p-md', low:'md-prio p-lo'};
    el.innerHTML = items.map(item =>
      '<div class="md-item' + (item.is_done ? ' done' : '') + '">'
      + '<div class="md-text' + (item.is_done ? ' done' : '') + '">' + item.text + '</div>'
      + '<div style="display:flex;align-items:center;gap:5px;flex-shrink:0">'
      + (item.priority ? '<span class="' + (pC[item.priority]||'md-prio') + '">' + (pM[item.priority]||'') + '</span>' : '')
      + '<button class="md-btn" onclick="toggleMD(\'' + item.id + '\',' + item.is_done + ')">' + (item.is_done ? 'â†©' : 'âœ“') + '</button>'
      + '<button class="md-btn" onclick="deleteMD(\'' + item.id + '\')">âœ•</button>'
      + '</div></div>'
    ).join('');
  } catch(e) { document.getElementById('md-list').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}
async function toggleMD(id, isDone) {
  await sb.from('mind_dump_items').update({is_done: !isDone}).eq('id', id);
  await loadMindDump();
}
async function deleteMD(id) {
  await sb.from('mind_dump_items').delete().eq('id', id);
  toast('Silindi');
  await loadMindDump();
}

// HABITS DAILY
async function loadHabitsDaily() {
  const el = document.getElementById('habits-daily');
  el.innerHTML = '<div class="loading"><div class="spin"></div></div>';
  try {
    await ensureDefaultHabits();
    const {data:habits} = await sb.from('habits').select('*').order('sort_order');
    if (!habits || !habits.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸŒ±</div>Zincir sekmesinden alÄ±ÅŸkanlÄ±k ekle!</div>'; return; }
    const {data:logs} = await sb.from('habit_logs').select('habit_id').eq('date', TODAY);
    const doneIds = new Set((logs||[]).map(l => l.habit_id));
    const total = habits.length, doneCount = habits.filter(h => doneIds.has(h.id)).length;
    const pct = total ? Math.round(doneCount/total*100) : 0;
    let h = '<div class="pbw"><div class="pbf" style="width:' + pct + '%"></div></div>'
      + '<div class="plbl" style="margin-bottom:16px"><span>BugÃ¼n</span><span>' + doneCount + '/' + total + ' (%' + pct + ')</span></div>';
    habits.forEach(habit => {
      const done = doneIds.has(habit.id);
      const hasNum = habit.target_value != null && habit.target_value > 0;
      if (hasNum) {
        const curVal = parseFloat(localStorage.getItem('hv_' + TODAY + '_' + habit.id) || '0');
        h += '<div style="padding:10px 0;border-bottom:1px solid var(--gray-l)">'
          + '<div style="font-size:14px;font-weight:600">' + habit.icon + ' ' + habit.name + '</div>'
          + '<div class="counter-row">'
          + '<button class="cnt-btn" onclick="habitCounter(\'' + habit.id + '\',' + habit.target_value + ',' + (habit.target_step||0.5) + ',-1)">âˆ’</button>'
          + '<div class="cnt-val" id="hcv-' + habit.id + '">' + curVal + '</div>'
          + '<span class="cnt-unit">/ ' + habit.target_value + ' ' + (habit.target_unit||'') + '</span>'
          + '<button class="cnt-btn" style="background:var(--gold);border-color:var(--gold);color:var(--navy)" onclick="habitCounter(\'' + habit.id + '\',' + habit.target_value + ',' + (habit.target_step||0.5) + ',1)">+</button>'
          + '</div></div>';
      } else {
        h += '<div class="ci" data-hid="' + habit.id + '" data-done="' + done + '" onclick="tickHabitEl(this)">'
          + '<div class="cb' + (done ? ' done' : '') + '">' + (done ? 'âœ“' : '') + '</div>'
          + '<div style="flex:1"><span class="cl' + (done ? ' done' : '') + '">' + habit.icon + ' ' + habit.name + '</span>'
          + (habit.description ? '<div style="font-size:11px;color:var(--gray);margin-top:1px">' + habit.description + '</div>' : '')
          + '</div></div>';
      }
    });
    if (doneCount === total && total > 0) {
      h += '<div style="background:var(--green-l);border-radius:var(--rs);padding:12px;text-align:center;font-size:14px;font-weight:600;color:var(--green);margin-top:12px">ğŸ‰ BugÃ¼n tÃ¼m alÄ±ÅŸkanlÄ±klar tamam!</div>';
    }
    el.innerHTML = h;
  } catch(e) { el.innerHTML = '<div class="empty">YÃ¼klenemedi: ' + e.message + '</div>'; }
}
function tickHabitEl(el) {
  const hid = el.dataset.hid, isDone = el.dataset.done === 'true';
  tickHabit(hid, isDone);
}
async function tickHabit(hid, isDone) {
  try {
    if (isDone) await sb.from('habit_logs').delete().eq('habit_id', hid).eq('date', TODAY);
    else { await sb.from('habit_logs').upsert({habit_id: hid, date: TODAY}, {onConflict: 'habit_id,date'}); toast('âœ“ YapÄ±ldÄ±!'); }
    await loadHabitsDaily();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function habitCounter(hid, target, step, dir) {
  const key = 'hv_' + TODAY + '_' + hid;
  let val = parseFloat(localStorage.getItem(key) || '0');
  val = Math.max(0, Math.round((val + dir * step) * 100) / 100);
  localStorage.setItem(key, val);
  const valEl = document.getElementById('hcv-' + hid);
  if (valEl) valEl.textContent = val;
  if (val >= target) {
    try { await sb.from('habit_logs').upsert({habit_id: hid, date: TODAY}, {onConflict: 'habit_id,date'}); toast('ğŸ¯ Hedef tamamlandÄ±!'); }
    catch(e) {}
  }
}

// ZINCIR
async function loadZincir() {
  document.getElementById('zincir-list').innerHTML = '<div class="loading"><div class="spin"></div></div>';
  try {
    await ensureDefaultHabits();
    const {data:habits} = await sb.from('habits').select('*').order('sort_order');
    if (!habits || !habits.length) { document.getElementById('zincir-list').innerHTML = '<div class="empty"><div class="empty-icon">ğŸŒ±</div>HenÃ¼z alÄ±ÅŸkanlÄ±k yok.</div>'; return; }
    const start = new Date(); start.setDate(start.getDate() - 27);
    const {data:logs} = await sb.from('habit_logs').select('habit_id,date').gte('date', start.toISOString().split('T')[0]);
    let totalStreak = 0, longestAll = 0;
    let html = '';
    for (const h of habits) {
      const hLogs = (logs||[]).filter(l => l.habit_id === h.id);
      const {streak, longest, days} = calcHabitStats(hLogs);
      totalStreak += streak;
      if (longest > longestAll) longestAll = longest;
      html += buildHabitCard(h, streak, longest, days);
    }
    document.getElementById('zincir-list').innerHTML = html;
    const avg = habits.length > 0 ? Math.round(totalStreak/habits.length) : 0;
    document.getElementById('z-num').textContent = avg;
    document.getElementById('z-rec').textContent = 'En uzun: ' + longestAll + ' gÃ¼n';
    document.getElementById('hdr-streak').textContent = 'ğŸ”¥ ' + avg + ' gÃ¼n';
  } catch(e) { document.getElementById('zincir-list').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}
async function ensureDefaultHabits() {
  const {data} = await sb.from('habits').select('id').limit(1);
  if (data && data.length) return;
  const defs = [
    {icon:'ğŸ’§',name:'Su â€” 2.5L',description:'GÃ¼nlÃ¼k hedef',sort_order:1,target_value:2.5,target_unit:'litre',target_step:0.5},
    {icon:'ğŸ’Š',name:'Supplement',description:'Sabah protokolÃ¼',sort_order:2},
    {icon:'âœ¨',name:'Affirmations',description:'Sesli okuma',sort_order:3},
    {icon:'ğŸ““',name:'Journaling',description:'3 ÅŸÃ¼kran + niyet',sort_order:4},
    {icon:'ğŸ“–',name:'Hollandaca Okuma',description:'15 dk',sort_order:5},
    {icon:'ğŸ¦·',name:'DiÅŸ FÄ±rÃ§alama',description:'Sabah + akÅŸam',sort_order:6},
    {icon:'ğŸš¿',name:'DuÅŸ',description:'Haftada min 3',sort_order:7},
  ];
  for (const d of defs) try { await sb.from('habits').insert(d); } catch(e) {}
}
function calcHabitStats(logs) {
  const days = {};
  logs.forEach(l => days[l.date] = true);
  let streak = 0;
  const d = new Date();
  for (let i = 0; i < 365; i++) {
    const ds = d.toISOString().split('T')[0];
    if (days[ds]) { streak++; d.setDate(d.getDate()-1); } else break;
  }
  const sorted = Object.keys(days).sort();
  let longest = 0, cur = 0, prev = null;
  sorted.forEach(ds => {
    if (prev) { const diff = Math.round((new Date(ds)-new Date(prev))/86400000); cur = diff===1 ? cur+1 : 1; }
    else cur = 1;
    if (cur > longest) longest = cur;
    prev = ds;
  });
  return {streak, longest, days};
}
function buildHabitCard(h, streak, longest, days) {
  const todayDone = days[TODAY] || false;
  let cal = '';
  for (let i = 27; i >= 0; i--) {
    const d = new Date(); d.setDate(d.getDate()-i);
    const ds = d.toISOString().split('T')[0];
    const isT = ds === TODAY, isFut = ds > TODAY, hit = days[ds] || false;
    cal += '<div class="cal-day"><div class="cal-box' + (hit?' hit':'') + (isT?' today':'') + (isFut?' fut':'') + '">' + (hit?'âœ“':'') + '</div>'
      + '<div class="cal-lbl' + (isT?' today':'') + '">' + DS[d.getDay()] + '</div></div>';
  }
  const eid = h.id;
  const hasNum = h.target_value != null && h.target_value > 0;
  let action = '';
  if (hasNum) {
    action = '<span style="font-size:12px;color:var(--gold);font-weight:600">' + (h.target_value) + ' ' + (h.target_unit||'') + '</span>';
  } else {
    action = '<button class="tick-btn' + (todayDone?' done':'') + '" onclick="tickHabit(\'' + eid + '\',' + todayDone + ')">' + (todayDone?'âœ“':'â—‹') + '</button>';
  }
  return '<div class="h-card"><div class="h-top">'
    + '<div class="h-icon">' + h.icon + '</div>'
    + '<div class="h-info"><div class="h-name">' + h.name + '</div><div class="h-sub">' + (h.description||'') + '</div></div>'
    + '<div class="h-streak"><div class="h-s-num">' + streak + '</div><div class="h-s-lbl">streak</div></div>'
    + action
    + '<button class="edit-btn" onclick="openEditHabit(\'' + eid + '\')">âœï¸</button>'
    + '</div><div class="cal-wrap"><div class="cal-row">' + cal + '</div></div>'
    + '<div class="h-best">ğŸ† En uzun streak: ' + longest + ' gÃ¼n</div></div>';
}
function openAddHabit() {
  editHabitId = null; selEmoji = EMOJIS[0];
  document.getElementById('hm-title').textContent = 'Yeni AlÄ±ÅŸkanlÄ±k';
  document.getElementById('h-name').value = '';
  document.getElementById('h-desc').value = '';
  document.getElementById('h-target').value = '';
  document.getElementById('h-unit').value = '';
  document.getElementById('h-step').value = '';
  document.getElementById('h-del-btn').style.display = 'none';
  document.getElementById('h-save-btn').textContent = 'Kaydet';
  renderEmojiGrid();
  document.getElementById('habit-modal').style.display = 'flex';
}
async function openEditHabit(id) {
  const {data:h} = await sb.from('habits').select('*').eq('id', id).single();
  editHabitId = id; selEmoji = h.icon || EMOJIS[0];
  document.getElementById('hm-title').textContent = 'DÃ¼zenle';
  document.getElementById('h-name').value = h.name;
  document.getElementById('h-desc').value = h.description || '';
  document.getElementById('h-target').value = h.target_value || '';
  document.getElementById('h-unit').value = h.target_unit || '';
  document.getElementById('h-step').value = h.target_step || '';
  document.getElementById('h-del-btn').style.display = 'block';
  document.getElementById('h-save-btn').textContent = 'GÃ¼ncelle';
  renderEmojiGrid();
  document.getElementById('habit-modal').style.display = 'flex';
}
function renderEmojiGrid() {
  document.getElementById('emoji-grid').innerHTML = EMOJIS.map(e =>
    '<button class="eg-btn' + (e === selEmoji ? ' act' : '') + '" onclick="selEmojiClick(\'' + e + '\')">' + e + '</button>'
  ).join('');
}
function selEmojiClick(e) { selEmoji = e; renderEmojiGrid(); }
async function saveHabit() {
  const name = document.getElementById('h-name').value.trim();
  if (!name) { toast('Ad gir!'); return; }
  const payload = {
    icon: selEmoji, name,
    description: document.getElementById('h-desc').value.trim(),
    target_value: parseFloat(document.getElementById('h-target').value) || null,
    target_unit: document.getElementById('h-unit').value.trim() || null,
    target_step: parseFloat(document.getElementById('h-step').value) || null,
  };
  try {
    if (editHabitId) { await sb.from('habits').update(payload).eq('id', editHabitId); toast('GÃ¼ncellendi!'); }
    else {
      const {data:ex} = await sb.from('habits').select('sort_order').order('sort_order',{ascending:false}).limit(1);
      payload.sort_order = (ex && ex.length ? ex[0].sort_order : 0) + 1;
      await sb.from('habits').insert(payload); toast('Eklendi!');
    }
    closeModal('habit-modal'); loadZincir();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function deleteHabit() {
  if (!editHabitId || !confirm('Silmek istediÄŸine emin misin?')) return;
  try {
    await sb.from('habit_logs').delete().eq('habit_id', editHabitId);
    await sb.from('habits').delete().eq('id', editHabitId);
    closeModal('habit-modal'); toast('Silindi'); loadZincir();
  } catch(e) { toast('Hata: ' + e.message); }
}

// WBS
async function loadWBS() {
  try {
    const {data:cats} = await sb.from('wbs_categories').select('*, wbs_tasks(*, wbs_microtasks(*))').order('sort_order');
    if (!cats) return;
    let total = 0, done = 0;
    cats.forEach(c => (c.wbs_tasks||[]).forEach(t => (t.wbs_microtasks||[]).forEach(m => { total++; if(m.is_completed) done++; })));
    const pct = total ? Math.round(done/total*100) : 0;
    document.getElementById('wbs-overall').innerHTML =
      '<div class="pbw"><div class="pbf" style="width:' + pct + '%"></div></div>'
      + '<div class="plbl"><span>Genel ilerleme</span><span>' + done + '/' + total + ' (%' + pct + ')</span></div>';
    document.getElementById('hdr-prog-fill').style.width = pct + '%';
    document.getElementById('hdr-prog-pct').textContent = '%' + pct;
    let html = '';
    cats.forEach(cat => {
      const tasks = cat.wbs_tasks || [];
      let ct = 0, cd = 0;
      tasks.forEach(t => (t.wbs_microtasks||[]).forEach(m => { ct++; if(m.is_completed) cd++; }));
      const cp = ct ? Math.round(cd/ct*100) : 0;
      let th = '';
      tasks.forEach(task => {
        const ms = task.wbs_microtasks || [];
        const allDone = ms.length > 0 && ms.every(m => m.is_completed);
        let mh = ms.map(m =>
          '<div class="mt-row" data-mid="' + m.id + '" data-done="' + m.is_completed + '" onclick="toggleMicro(this)">'
          + '<div class="mt-check' + (m.is_completed?' done':'') + '">' + (m.is_completed?'âœ“':'') + '</div>'
          + '<span class="mt-lbl' + (m.is_completed?' done':'') + '">' + m.title + '</span>'
          + '</div>'
        ).join('');
        th += '<div class="task-group">'
          + '<div class="wbs-task' + (allDone?' done':'') + '"><span>' + (allDone?'âœ…':'â—‹') + '</span>' + task.title + '</div>'
          + mh + '</div>';
      });
      html += '<div class="card"><div class="cat-hdr" onclick="toggleCat(\'wc-' + cat.id + '\')">'
        + '<div class="cat-name">' + cat.label + '</div>'
        + '<div class="cat-prog">' + cd + '/' + ct + ' Â· %' + cp + '</div></div>'
        + '<div class="pbw"><div class="pbf" style="width:' + cp + '%"></div></div>'
        + '<div id="wc-' + cat.id + '" style="margin-top:8px">' + th + '</div></div>';
    });
    document.getElementById('wbs-list').innerHTML = html;
  } catch(e) { document.getElementById('wbs-list').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}
function toggleCat(id) { const el = document.getElementById(id); el.style.display = el.style.display==='none'?'block':'none'; }
async function toggleMicro(el) {
  const id = el.dataset.mid, cur = el.dataset.done === 'true';
  try {
    await sb.from('wbs_microtasks').update({is_completed: !cur, completed_at: !cur ? new Date().toISOString() : null}).eq('id', id);
    if (!cur) toast('âœ… TamamlandÄ±!');
    await loadWBS();
  } catch(e) { toast('Hata: ' + e.message); }
}

// LOG
function setNewLogType(t, btn) {
  newLogType = t;
  document.querySelectorAll('#log-type-tabs .type-tab').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
}
function setLogStatus(s, btn) {
  logStatus = s;
  document.querySelectorAll('#log-status-tabs .type-tab').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
}
function setLogFilter(f, btn) {
  document.querySelectorAll('#tab-log .type-tabs .type-tab').forEach(b => b.classList.remove('act'));
  btn.classList.add('act');
  loadLog(f);
}
function renderLogRating() {
  const row = document.getElementById('log-rating-row');
  if (!row) return;
  row.innerHTML = '';
  for (let i = 1; i <= 5; i++) {
    const b = document.createElement('button');
    b.className = 'rating-btn' + (i <= logRating ? ' act' : '');
    b.textContent = i + 'â˜…';
    const val = i;
    b.onclick = () => { logRating = val; renderLogRating(); };
    row.appendChild(b);
  }
}
function openAddLog() {
  logRating = 0; newLogType = 'book'; logStatus = 'reading';
  document.getElementById('log-title-in').value = '';
  document.getElementById('log-author-in').value = '';
  document.getElementById('log-note-in').value = '';
  renderLogRating();
  document.querySelectorAll('#log-type-tabs .type-tab').forEach((b,i) => b.classList.toggle('act', i===0));
  document.querySelectorAll('#log-status-tabs .type-tab').forEach((b,i) => b.classList.toggle('act', i===0));
  document.getElementById('log-modal').style.display = 'flex';
}
async function saveLog() {
  const title = document.getElementById('log-title-in').value.trim();
  if (!title) { toast('BaÅŸlÄ±k gir!'); return; }
  try {
    await sb.from('content_logs').insert({
      title, author: document.getElementById('log-author-in').value.trim(),
      type: newLogType, rating: logRating || null,
      note: document.getElementById('log-note-in').value.trim(),
      status: logStatus, logged_date: TODAY,
    });
    closeModal('log-modal'); toast('âœ… Kaydedildi!'); loadLog();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function loadLog(filterType) {
  const ft = filterType || 'all';
  try {
    let q = sb.from('content_logs').select('*').order('logged_date', {ascending: false});
    if (ft !== 'all') q = q.eq('type', ft);
    const {data} = await q;
    const el = document.getElementById('log-list');
    if (!data || !data.length) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“š</div>HenÃ¼z iÃ§erik eklenmedi.</div>'; return; }
    el.innerHTML = data.map(item => {
      const stars = item.rating ? 'â˜…'.repeat(item.rating) + 'â˜†'.repeat(5-item.rating) : '';
      return '<div class="log-item">'
        + '<div style="font-size:18px;width:36px;text-align:center">' + (LOG_ICONS[item.type]||'ğŸ“„') + '</div>'
        + '<div class="log-info">'
        + '<div class="log-title-txt">' + item.title + '</div>'
        + '<div class="log-meta">' + (item.author?item.author+' Â· ':'') + (STATUS_LBL[item.status]||item.status) + (stars?' Â· <span style="color:var(--gold)">'+stars+'</span>':'') + '</div>'
        + (item.note ? '<div style="font-size:12px;color:var(--gray);margin-top:3px">' + item.note + '</div>' : '')
        + '</div>'
        + '<button class="log-del" onclick="deleteLog(\'' + item.id + '\')">âœ•</button></div>';
    }).join('');
  } catch(e) { document.getElementById('log-list').innerHTML = '<div class="empty">YÃ¼klenemedi: ' + e.message + '</div>'; }
}
async function deleteLog(id) { await sb.from('content_logs').delete().eq('id', id); toast('Silindi'); loadLog(); }

// SAÄLIK
function initSaglik() {
  document.getElementById('saglik-date').value = TODAY;
  loadSaglikHistory();
}
async function saveSaglik() {
  const date = document.getElementById('saglik-date').value || TODAY;
  try {
    await sb.from('health_logs').upsert({
      log_date: date,
      sleep_hours: parseFloat(document.getElementById('saglik-sleep-h').value) || null,
      sleep_quality: parseInt(document.getElementById('saglik-sleep-q').value) || null,
      exercise: document.getElementById('saglik-exercise').value.trim(),
      food: document.getElementById('saglik-food').value.trim(),
      water_liters: parseFloat(document.getElementById('saglik-water').value) || null,
      note: document.getElementById('saglik-note').value.trim(),
    }, {onConflict: 'log_date'});
    toast('âœ… Kaydedildi!');
    await loadSaglikHistory();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function loadSaglikHistory() {
  try {
    const {data} = await sb.from('health_logs').select('*').order('log_date', {ascending: false}).limit(14);
    const el = document.getElementById('saglik-history');
    if (!data || !data.length) { el.innerHTML = '<div class="empty">HenÃ¼z log yok.</div>'; return; }
    el.innerHTML = data.map(d =>
      '<div class="health-entry">'
      + '<div style="display:flex;justify-content:space-between;margin-bottom:4px">'
      + '<span style="font-size:13px;font-weight:600">' + d.log_date + '</span>'
      + '<span style="font-size:12px;color:var(--gray)">' + (d.sleep_hours?'ğŸ˜´ '+d.sleep_hours+'s ':''  ) + (d.water_liters?'ğŸ’§ '+d.water_liters+'L':'') + '</span>'
      + '</div>'
      + (d.exercise ? '<div style="font-size:12px;color:var(--green)">ğŸ‹ï¸ ' + d.exercise + '</div>' : '')
      + (d.food ? '<div style="font-size:12px;color:var(--gray)">ğŸ¥— ' + d.food + '</div>' : '')
      + (d.note ? '<div style="font-size:12px;color:var(--navy);margin-top:2px">ğŸ“ ' + d.note + '</div>' : '')
      + '</div>'
    ).join('');
  } catch(e) { document.getElementById('saglik-history').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}

// OPTÄ°MAÄ°ZED
async function loadOpt() {
  try {
    const {data} = await sb.from('optimaized_metrics').select('*').eq('week_start', getMonday()).maybeSingle();
    const el = document.getElementById('opt-view');
    if (!data) { el.innerHTML = '<div class="empty"><div class="empty-icon">âš¡</div>Bu hafta henÃ¼z metrik girilmedi.</div>'; }
    else {
      el.innerHTML = '<div class="kpi-grid">'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.content_prepared||0) + '</div><div class="kpi-lbl">HazÄ±rlanan</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.content_published||0) + '</div><div class="kpi-lbl">PaylaÅŸÄ±lan</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.followers||0) + '</div><div class="kpi-lbl">TakipÃ§i</div><div class="kpi-tgt">+' + (data.follower_gain||0) + '</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.views||0) + '</div><div class="kpi-lbl">Ä°zlenme</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.likes||0) + '</div><div class="kpi-lbl">BeÄŸeni</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.saves||0) + '</div><div class="kpi-lbl">Kaydetme</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.reach||0) + '</div><div class="kpi-lbl">Reach</div></div>'
        + '<div class="kpi-card"><div class="kpi-val">' + (data.sales||0) + '</div><div class="kpi-lbl">SatÄ±ÅŸ</div><div class="kpi-tgt">â‚¬' + (data.revenue||0) + '</div></div>'
        + '</div>';
      const map = {prepared:'opt-prepared',published:'opt-published',reels:'opt-reels',stories:'opt-stories',followers:'opt-followers',follower_gain:'opt-fgain',views:'opt-views',likes:'opt-likes',saves:'opt-saves',reach:'opt-reach',sales:'opt-sales',revenue:'opt-revenue'};
      const dmap = {prepared:data.content_prepared,published:data.content_published,reels:data.reels,stories:data.stories,followers:data.followers,follower_gain:data.follower_gain,views:data.views,likes:data.likes,saves:data.saves,reach:data.reach,sales:data.sales,revenue:data.revenue};
      Object.entries(map).forEach(([k,id]) => { const e2=document.getElementById(id); if(e2&&dmap[k]!=null) e2.value=dmap[k]; });
    }
    loadOptHistory();
  } catch(e) { document.getElementById('opt-view').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}
async function saveOpt() {
  const g = id => parseFloat(document.getElementById(id)?.value) || 0;
  try {
    await sb.from('optimaized_metrics').upsert({
      week_start: getMonday(),
      content_prepared: g('opt-prepared'), content_published: g('opt-published'),
      reels: g('opt-reels'), stories: g('opt-stories'),
      followers: g('opt-followers'), follower_gain: g('opt-fgain'),
      views: g('opt-views'), likes: g('opt-likes'), saves: g('opt-saves'),
      reach: g('opt-reach'), sales: g('opt-sales'), revenue: g('opt-revenue'),
    }, {onConflict: 'week_start'});
    toast('âœ… Kaydedildi!'); loadOpt();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function loadOptHistory() {
  try {
    const {data} = await sb.from('optimaized_metrics').select('*').order('week_start', {ascending: false}).limit(8);
    const el = document.getElementById('opt-history');
    if (!data || !data.length) { el.innerHTML = '<div class="empty">HenÃ¼z veri yok.</div>'; return; }
    el.innerHTML = data.map(d =>
      '<div class="opt-entry">'
      + '<div style="font-size:12px;font-weight:600;color:var(--gold);margin-bottom:4px">Hafta: ' + d.week_start + '</div>'
      + '<div style="display:flex;flex-wrap:wrap;gap:8px;font-size:12px;color:var(--gray)">'
      + '<span>ğŸ“¤ ' + (d.content_published||0) + ' paylaÅŸÄ±m</span>'
      + '<span>ğŸ‘¥ ' + (d.followers||0) + ' (+' + (d.follower_gain||0) + ')</span>'
      + '<span>ğŸ‘ï¸ ' + (d.views||0) + '</span>'
      + '<span>ğŸ’° â‚¬' + (d.revenue||0) + '</span>'
      + '</div></div>'
    ).join('');
  } catch(e) {}
}

// KPI
async function loadKPI() {
  try {
    const {data} = await sb.from('weekly_kpi').select('*').eq('week_start', getMonday()).maybeSingle();
    const el = document.getElementById('kpi-view');
    if (!data) { el.innerHTML = '<div class="empty"><div class="empty-icon">ğŸ“Š</div>Bu hafta henÃ¼z KPI girilmedi.</div>'; return; }
    const s = data.microtask_completion_pct || 0;
    el.innerHTML = (s >= 70 ? '<div class="celebrate" style="margin-bottom:12px"><div class="cel-icon">ğŸ‰</div><div class="cel-title">BaÅŸarÄ±lÄ± Hafta!</div><div class="cel-txt">%' + s + ' tamamlandÄ±</div></div>' : '')
      + '<div class="kpi-grid">'
      + '<div class="kpi-card"><div class="kpi-val">%' + s + '</div><div class="kpi-lbl">Task Tamamlama</div><div class="kpi-tgt">â‰¥%70</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.water_days||0) + '/7</div><div class="kpi-lbl">Su 2.5L</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">%' + (data.supplement_pct||0) + '</div><div class="kpi-lbl">Supplement</div><div class="kpi-tgt">â‰¥%80</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.reels_published||0) + '</div><div class="kpi-lbl">Reels</div><div class="kpi-tgt">3/hafta</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">' + (data.energy_avg||0) + '</div><div class="kpi-lbl">Enerji Ort.</div><div class="kpi-tgt">â‰¥6</div></div>'
      + '<div class="kpi-card"><div class="kpi-val">%' + (data.habit_compliance_pct||0) + '</div><div class="kpi-lbl">Rutin Uyum</div><div class="kpi-tgt">â‰¥%70</div></div>'
      + '</div>';
  } catch(e) { document.getElementById('kpi-view').innerHTML = '<div class="empty">YÃ¼klenemedi</div>'; }
}
function renderKPIForm() {
  const fields = [
    {id:'kf-task',l:'Task Tamamlama %'},{id:'kf-water',l:'Su 2.5L GÃ¼nleri'},
    {id:'kf-suppl',l:'Supplement Uyum %'},{id:'kf-reels',l:'Reels SayÄ±sÄ±'},
    {id:'kf-energy',l:'Enerji OrtalamasÄ±'},{id:'kf-habit',l:'Rutin Uyum %'},
  ];
  document.getElementById('kpi-form').innerHTML = fields.map(f =>
    '<div style="margin-bottom:8px"><div style="font-size:12px;color:var(--gray);font-weight:600;margin-bottom:3px">' + f.l + '</div>'
    + '<input type="number" id="' + f.id + '" class="ifield"></div>'
  ).join('');
}
async function saveKPI() {
  const g = id => +(document.getElementById(id).value||0);
  try {
    await sb.from('weekly_kpi').upsert({
      week_start: getMonday(),
      microtask_completion_pct: g('kf-task'), water_days: g('kf-water'),
      supplement_pct: g('kf-suppl'), reels_published: g('kf-reels'),
      energy_avg: g('kf-energy'), habit_compliance_pct: g('kf-habit'),
    }, {onConflict: 'week_start'});
    toast('ğŸ“Š KPI kaydedildi!'); loadKPI();
  } catch(e) { toast('Hata: ' + e.message); }
}

// VISION BOARD
async function loadVisionBoard() {
  try {
    const {data} = await sb.from('vision_board_items').select('*').order('created_at', {ascending: false});
    const el = document.getElementById('vb-grid');
    if (!data || !data.length) { el.innerHTML = '<div style="grid-column:1/-1" class="empty"><div class="empty-icon">ğŸŒŸ</div>GÃ¶rsel veya not ekle!</div>'; return; }
    el.innerHTML = data.map(item => {
      if (item.type === 'image') {
        return '<div class="vb-img"><img src="' + item.content + '"><button class="vb-del" onclick="deleteVB(\'' + item.id + '\')">âœ•</button></div>';
      } else {
        const textColor = item.bg_color === '#1B2A4A' ? '#fff' : 'var(--navy)';
        return '<div class="vb-note" style="background:' + (item.bg_color||'#F5EDD6') + '">'
          + '<div style="font-size:13px;font-weight:500;text-align:center;color:' + textColor + ';line-height:1.5">' + item.content + '</div>'
          + '<button class="vb-del" onclick="deleteVB(\'' + item.id + '\')">âœ•</button></div>';
      }
    }).join('');
  } catch(e) { document.getElementById('vb-grid').innerHTML = '<div style="grid-column:1/-1" class="empty">YÃ¼klenemedi</div>'; }
}
function openVBNote() {
  vbColor = '#F5EDD6';
  document.getElementById('vb-note-text').value = '';
  document.querySelectorAll('.color-swatch').forEach((s,i) => s.classList.toggle('act', i===0));
  document.getElementById('vb-modal').style.display = 'flex';
}
function setVBColor(color, el) {
  vbColor = color;
  document.querySelectorAll('.color-swatch').forEach(s => s.classList.remove('act'));
  el.classList.add('act');
}
async function saveVBNote() {
  const text = document.getElementById('vb-note-text').value.trim();
  if (!text) { toast('Bir ÅŸeyler yaz!'); return; }
  try {
    await sb.from('vision_board_items').insert({type: 'note', content: text, bg_color: vbColor});
    closeModal('vb-modal'); toast('âœ… Eklendi!'); loadVisionBoard();
  } catch(e) { toast('Hata: ' + e.message); }
}
async function uploadVBImg(event) {
  const file = event.target.files[0];
  if (!file) return;
  toast('YÃ¼kleniyor...');
  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      await sb.from('vision_board_items').insert({type: 'image', content: e.target.result});
      toast('âœ… Eklendi!'); loadVisionBoard();
    } catch(err) { toast('Hata: ' + err.message); }
  };
  reader.readAsDataURL(file);
  event.target.value = '';
}
async function deleteVB(id) {
  await sb.from('vision_board_items').delete().eq('id', id);
  toast('Silindi'); loadVisionBoard();
}

// AYARLAR
function loadAyarlar() {
  const d = getDeadline();
  const diff = Math.ceil((d - new Date()) / (1000*60*60*24));
  document.getElementById('cd-current').textContent = d.getDate() + ' ' + MN[d.getMonth()] + ' ' + d.getFullYear();
  document.getElementById('cd-left').textContent = diff > 0 ? diff + ' gÃ¼n kaldÄ±' : 'SÃ¼re doldu';
  loadTGSettings();
}
function saveDeadline() {
  const val = document.getElementById('cd-new-date').value;
  if (!val) { toast('Bir tarih seÃ§!'); return; }
  localStorage.setItem(DEADLINE_KEY, val + 'T00:00:00');
  updateCountdown(); loadAyarlar();
  toast('âœ… Tarih gÃ¼ncellendi!');
}
async function loadTGSettings() {
  try {
    const {data} = await sb.from('notification_settings').select('*').limit(1).maybeSingle();
    if (data) {
      if (data.telegram_bot_token) document.getElementById('tg-token').value = data.telegram_bot_token;
      if (data.telegram_chat_id) document.getElementById('tg-chatid').value = data.telegram_chat_id;
    }
  } catch(e) {}
}
async function saveTG() {
  const token = document.getElementById('tg-token').value.trim(), chatId = document.getElementById('tg-chatid').value.trim();
  if (!token || !chatId) { toast('Token ve Chat ID gerekli!'); return; }
  try {
    const {data:ex} = await sb.from('notification_settings').select('id').limit(1).maybeSingle();
    if (ex) await sb.from('notification_settings').update({telegram_bot_token:token,telegram_chat_id:chatId}).eq('id',ex.id);
    else await sb.from('notification_settings').insert({telegram_bot_token:token,telegram_chat_id:chatId});
    toast('âœ… Telegram kaydedildi!');
  } catch(e) { toast('Hata: ' + e.message); }
}
async function testTG() {
  const token = document.getElementById('tg-token').value.trim(), chatId = document.getElementById('tg-chatid').value.trim();
  if (!token || !chatId) { toast('Ã–nce token ve Chat ID gir!'); return; }
  try {
    const r = await fetch('https://api.telegram.org/bot' + token + '/sendMessage', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({chat_id: chatId, text: 'Lock-In 2025 baÄŸlantÄ±sÄ± kuruldu! ğŸš€'})
    });
    const d = await r.json();
    toast(d.ok ? 'âœ… Test gÃ¶nderildi!' : 'Hata: ' + d.description);
  } catch(e) { toast('BaÄŸlantÄ± hatasÄ±'); }
}
async function sendTG(text) {
  try {
    const {data} = await sb.from('notification_settings').select('*').limit(1).maybeSingle();
    if (!data || !data.telegram_bot_token) return;
    await fetch('https://api.telegram.org/bot' + data.telegram_bot_token + '/sendMessage', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({chat_id: data.telegram_chat_id, text})
    });
  } catch(e) {}
}

// STREAK
async function calcStreak() {
  try {
    const {data} = await sb.from('daily_checkins').select('date').eq('type','morning').order('date',{ascending:false}).limit(60);
    if (!data || !data.length) return;
    let streak = 0;
    const base = new Date(); base.setHours(0,0,0,0);
    for (let i = 0; i < data.length; i++) {
      const exp = new Date(base); exp.setDate(base.getDate()-i);
      if (data[i].date === exp.toISOString().split('T')[0]) streak++;
      else break;
    }
    document.getElementById('hdr-streak').textContent = 'ğŸ”¥ ' + streak + ' gÃ¼n';
  } catch(e) {}
}

// INIT
window.addEventListener('DOMContentLoaded', async () => {
  initHeader();
  renderEnergyBtns();
  renderDayScoreBtns();
  renderKPIForm();
  renderLogRating();
  setPrio('med');
  // Restore persisted checks from localStorage
  const savedMC = localStorage.getItem('mc_' + TODAY);
  if (savedMC) morningChecks = JSON.parse(savedMC);
  const savedEC = localStorage.getItem('ec_' + TODAY);
  if (savedEC) eveningChecks = JSON.parse(savedEC);
  // Render lists immediately so they're visible
  renderMorningList();
  renderEveningList();
  await loadTodayCheckin();
  await loadTodayTasks();
  await calcStreak();
  await loadHeaderProgress();
});
</script>
</body>
</html>
